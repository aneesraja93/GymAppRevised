<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muscles & Fitness</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="vendor/fontawesome/css/all.min.css" />
    <script src="vendor/chart.js/chart.min.js"></script>
    <link href="css/inter-font.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; max-width: 90%; width: 600px; max-height: 90vh; overflow-y: auto; }
        .sortable:hover { cursor: pointer; background-color: #f9fafb; }
        .sort-asc::after { content: ' ▲'; font-size: 0.7em; color: #6b7280; }
        .sort-desc::after { content: ' ▼'; font-size: 0.7em; color: #6b7280; }
        .input-success { background-color: #ecfdf5; border-color: #10b981; }
        .modal-content-sm { width: 450px; }
        .modal-content-md { width: 700px; }
        .modal-content-lg { width: 850px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .gender-filter-active { background-color: #e0e7ff; color: #4f46e5; border-color: #a5b4fc; }
        .gender-filter-btn:not(.gender-filter-active):hover { background-color: #f3f4f6; }
        .status-paid { background-color: #dcfce7; color: #065f46; }
        .status-due { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #fef9c3; color: #ca8a04; }
        .status-error { background-color: #f3f4f6; color: #6b7280; }
        .payment-section { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .payment-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .year-nav-btn { background-color: #e5e7eb; border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; }
        .year-nav-btn:hover { background-color: #d1d5db; }
        .table-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }
        .filter-tag { cursor: pointer; padding: 0.25rem 0.75rem; border-radius: 9999px; border: 1px solid #d1d5db; font-size: 0.875rem; color: #4b5563; background-color: white; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .filter-tag:not(.filter-tag-active):hover { background-color: #e0e7ff; color: #4338ca; border-color: #4338ca; }
        .filter-tag-active { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        .stat-card { position: relative; }
        .reveal-btn {
            cursor: pointer;
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.2s;
        }
        .reveal-btn:hover { color: rgba(255, 255, 255, 1); }
        .reveal-btn i { font-size: 1.1rem; }

        .suggestions-container {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            z-index: 10;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
        }
        .suggestion-item small {
            color: #6b7280;
            margin-left: 0.5rem;
        }
        #sales-chart-canvas-container.blurred {
            filter: blur(4px);
        }
        .ledger-payment-item {
            cursor: pointer;
            text-decoration: underline;
        }
        .ledger-payment-item-monthly { color: #16a34a; /* green-600 */ }
        .ledger-payment-item-monthly:hover { color: #15803d; /* green-700 */ }
	.ledger-payment-item-admission {
            color: #2563eb; /* blue-600 (Tailwind) */
        }
        .ledger-payment-item-admission:hover {
            color: #1d4ed8; /* blue-700 (Tailwind) */
        }

        .ledger-writeoff-item {
            cursor: pointer;
            text-decoration: underline;
            color: #ef4444; /* red-500 */
        }
        .ledger-writeoff-item:hover {
            color: #b91c1c; /* red-700 */
        }
        .inactive-period-row {
            background-color: #f3f4f6; /* gray-100 */
            color: #6b7280; /* gray-500 */
        }
        .inactive-period-text {
            cursor: pointer;
        }
        .inactive-period-text:hover {
            text-decoration: underline;
        }

	.ledger-row-past { background-color: #f5fff5; /* A light grey */ }
	.ledger-row-current { background-color: #e0f8e0; /* A slightly darker grey */ }

        .history-entry-fixed {
            color: #6b7280; /* gray-500 */
        }
         .btn-icon-text { display: inline-flex; align-items: center; }
         .btn-icon-text i { margin-right: 0.35rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <div class="w-64 bg-white shadow-md flex flex-col">
            <div class="p-6 flex items-center justify-center">
                <!-- IMPORTANT: Ensure logo.png is in public/logo.png -->
                <img src="logo.png" 
                     alt="GymPro Logo"
                     class="h-25 w-auto"
                    >
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#home" class="tab-link flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md" data-tab="home">
                    <i class="fas fa-home text-blue-500 w-5 mr-3"></i> Home
                </a>
                <a href="#memberships" class="tab-link flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md" data-tab="memberships">
                    <i class="fas fa-users text-green-700 w-5 mr-3"></i> Memberships
                </a>
                <a href="#ledger" class="tab-link flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md" data-tab="ledger">
                    <i class="fas fa-book text-purple-500 w-5 mr-3"></i> Ledger
                </a>
                <a href="#revenue" class="tab-link flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md" data-tab="revenue">
                    <i class="fas fa-chart-line text-red-600 w-5 mr-3"></i> Revenue
                </a>
                <a href="#backup" class="tab-link flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md" data-tab="backup">
                    <i class="fas fa-save text-yellow-600 w-5 mr-3"></i> Backup
                </a>
            </nav>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm p-4 flex justify-end items-center">
                 <div></div> </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div id="home-content" class="tab-content">
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-red-700 to-red-500 text-white p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-4xl font-semibold">Muscles & Fitness</h2>
                        <p class="mt-1"> Your Strongest Chapter Starts Here.</p>
                    </div>

                    <div id="home-content" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Column: Recent Payments -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-700">
                                    <i class="fas fa-receipt mr-2 text-green-600"></i>Payments Received Today
                                </h3>
                                <div id="home-payments-gender-filter-controls" class="flex space-x-1">
                                    <button class="gender-filter-btn p-1 rounded-md border border-gray-300 text-gray-600 text-xs gender-filter-active" data-gender="all" title="Combined"><i class="fas fa-users text-green-700 fa-fw"></i></button>
                                    <button class="gender-filter-btn p-1 rounded-md border border-gray-300 text-gray-600 text-xs" data-gender="Male" title="Gents"><i class="fas fa-person text-blue-500 fa-fw"></i></button>
                                    <button class="gender-filter-btn p-1 rounded-md border border-gray-300 text-gray-600 text-xs" data-gender="Female" title="Ladies"><i class="fas fa-person-dress text-pink-500 fa-fw"></i></button>
                                </div>
                            </div>
                            <ul id="recent-payments-list" class="space-y-3 max-h-[45vh] overflow-y-auto no-scrollbar">
                                <!-- JS will populate this -->
                                <li class="text-gray-500 py-2">Loading recent payments...</li>
                            </ul>
                        </div>
                        <!-- Right Column: Recent Members -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-700">
                                    <i class="fas fa-user-plus mr-2 text-blue-600"></i>New Joins This Month
                                </h3>
                                <div id="home-joins-gender-filter-controls" class="flex space-x-1">
                                    <button class="gender-filter-btn p-1 rounded-md border border-gray-300 text-gray-600 text-xs gender-filter-active" data-gender="all" title="Combined"><i class="fas fa-users text-green-700 fa-fw"></i></button>
                                    <button class="gender-filter-btn p-1 rounded-md border border-gray-300 text-gray-600 text-xs" data-gender="Male" title="Gents"><i class="fas fa-person text-blue-500 fa-fw"></i></button>
                                    <button class="gender-filter-btn p-1 rounded-md border border-gray-300 text-gray-600 text-xs" data-gender="Female" title="Ladies"><i class="fas fa-person-dress text-pink-500 fa-fw"></i></button>
                                </div>
                            </div>
                            <ul id="recent-joins-list" class="space-y-3 max-h-[45vh] overflow-y-auto no-scrollbar">
                                <!-- JS will populate this -->
                                <li class="text-gray-500 py-2">Loading recent joins...</li>
                            </ul>
                        </div>
                    </div>
                </div>
                </div>
                <div id="revenue-content" class="tab-content hidden">
                    <div class="flex justify-end mb-4">
                         <div id="gender-filter-controls" class="flex space-x-2">
                              <button class="gender-filter-btn p-2 rounded-md border border-gray-300 text-gray-600 gender-filter-active" data-gender="all" title="Combined"> <i class="fas fa-users text-green-700 fa-fw"></i> </button>
                              <button class="gender-filter-btn p-2 rounded-md border border-gray-300 text-gray-600" data-gender="Male" title="Gents"> <i class="fas fa-person text-blue-500 fa-fw"></i> </button>
                              <button class="gender-filter-btn p-2 rounded-md border border-gray-300 text-gray-600" data-gender="Female" title="Ladies"> <i class="fas fa-person-dress text-pink-500 fa-fw"></i> </button>
                          </div>
                     </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white p-6 rounded-lg shadow-md flex flex-col justify-between h-36 stat-card">
                             <div class="flex justify-between items-start">
                                <div class="text-sm uppercase tracking-wide font-semibold">Total Active Members</div>
                                <i class="fas fa-users text-3xl opacity-50"></i>
                            </div>
                            <div class="text-4xl font-bold self-start" id="total-active-members">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-400 to-purple-600 text-white p-6 rounded-lg shadow-md flex flex-col justify-between h-36 stat-card">
                             <div class="flex justify-between items-start">
                                <div class="text-sm uppercase tracking-wide font-semibold">Expected Monthly Revenue</div>
                                <i class="fas fa-chart-line text-3xl opacity-50"></i>
                            </div>
                            <div class="text-3xl font-bold self-start" id="expected-monthly-revenue">•••••• Rs</div>
                            <button id="reveal-revenue-btn" class="reveal-btn" title="Reveal Revenue">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                        </div>
                        <div class="bg-gradient-to-br from-red-400 to-red-600 text-white p-6 rounded-lg shadow-md flex flex-col justify-between h-36 stat-card">
                             <div class="flex justify-between items-start">
                                <div class="text-sm uppercase tracking-wide font-semibold">Total Fees Overdue</div>
                                <i class="fas fa-exclamation-triangle text-3xl opacity-50"></i>
                            </div>
                            <div class="text-3xl font-bold self-start" id="fees-overdue">•••••• Rs</div>
                             <button id="reveal-overdue-btn" class="reveal-btn" title="Reveal Overdue">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4 relative">
                            <div class="w-10 flex-shrink-0"> <button id="toggle-chart-blur-btn"
                                        class="text-gray-500 hover:text-gray-700 p-1 focus:outline-none"
                                        title="Unblur chart">
                                    <i class="fas fa-eye-slash fa-fw text-lg"></i>
                                </button>
                            </div>

                            <div class="flex-grow text-center">
                                <h3 class="text-lg font-semibold text-gray-700">Monthly Sales History</h3>
                            </div>

                            <div class="w-auto flex-shrink-0 flex items-center space-x-2"> <button id="prev-year-btn" class="year-nav-btn">&lt; Prev</button>
                                <span id="current-chart-year-display" class="font-semibold text-gray-700"></span>
                                <button id="next-year-btn" class="year-nav-btn">Next &gt;</button>
                            </div>
                        </div>
                        <div id="sales-chart-outer-container" class="relative">
                            <div id="sales-chart-canvas-container" class="h-64 md:h-96">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    </div>

                <div id="memberships-content" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div id="member-filter-tags-container" class="mb-4 flex flex-wrap gap-2 items-center">
                             <span class="text-sm font-medium text-gray-700 mr-2">Filter by:</span>
                             <button class="filter-tag" data-filter="all">All</button>
                             <button class="filter-tag" data-filter="overdue">Overdue</button>
                             <button class="filter-tag filter-tag-active" data-filter="active">Active</button>
                             <button class="filter-tag" data-filter="inactive">Inactive</button>
                             <button class="filter-tag" data-filter="Male">Male</button>
                             <button class="filter-tag" data-filter="Female">Female</button>
                             <span id="member-filter-count" class="ml-auto text-sm text-gray-600"></span>
                         </div>

                        <div class="flex flex-col md:flex-row justify-end md:items-center mb-4 gap-4">
                             <div class="flex flex-col md:flex-row items-stretch md:items-center gap-2">
                                <input type="text" id="member-search" placeholder="Type to search..." class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 flex-grow">
                                <button id="add-member-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                                    <i class="fas fa-plus mr-2"></i> Add Member
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider sortable" data-sort="name">Name</th>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider sortable" data-sort="mobile">Mobile</th>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider sortable" data-sort="joinDate">Join Date</th>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider sortable" data-sort="fees">Fee Status</th>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider sortable" data-sort="status">Member Status</th>
                                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="members-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="6" class="text-center py-4 text-gray-500">Loading members...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="members-pagination-controls" class="mt-4 flex justify-between items-center">
                            <!-- Pagination controls will be rendered here by JavaScript -->
                            </table>
                        </div>
                    </div>
                </div>

                <div id="ledger-content" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="payment-section">
                            <div class="mb-4 relative flex items-end gap-2">
                                <div class="flex-grow">
                                    <label for="ledger-member-input" class="block text-sm font-medium text-gray-700">Select Member</label>
                                    <input type="text" id="ledger-member-input" autocomplete="off" placeholder="Type name or mobile..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out">

                                    <div id="ledger-member-suggestions" class="suggestions-container hidden"></div>
                                </div>
                                <!-- Action buttons for selected ledger member -->
                                <button id="clear-ledger-selection-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md text-sm hidden mr-2" title="Clear Selection">
                                    <i class="fas fa-times mr-1"></i> Clear
                                </button>
                                <button id="edit-ledger-member-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md text-sm hidden mr-2" title="Edit Member Details">
                                    <i class="fas fa-edit mr-1"></i> Edit Member
                                </button>
                                <button id="view-member-history-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md text-sm hidden" title="View/Edit Member History">
                                    <i class="fas fa-history mr-1"></i> View History
                                </button>
                            </div>

                            <!-- START: Combined Ledger Controls Header (Year Nav + Overdue) -->
                            <div id="ledger-controls-header" class="relative my-4 hidden">
                                <!-- Centered Year Navigation Group -->
                                <div class="flex justify-center items-center space-x-2">
                                    <button id="ledger-prev-year-btn" class="year-nav-btn">< Prev Year</button>
                                    <span id="current-ledger-year-display" class="font-semibold text-gray-700"></span>
                                    <button id="ledger-next-year-btn" class="year-nav-btn">Next Year ></button>
                                </div>
                            
                                <!-- Absolutely Positioned Overdue Display on the Right -->
                                <div id="ledger-member-overdue-container" class="absolute top-0 right-0 text-right">
                                     <p class="flex items-baseline space-x-1">
                                        <span class="text-xs font-medium text-gray-500 uppercase">Current Dues:</span>
                                        <span id="ledger-member-overdue-amount" class="text-base font-bold text-red-600">0 Rs</span>
                                     </p>
                                </div>
                            </div>
                            <!-- END: Combined Ledger Controls Header -->

                            <div id="ledger-details-container" class="mt-2 hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-800 uppercase tracking-wider">Membership Period</th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-800 uppercase tracking-wider">Fees (Rs)</th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-800 uppercase tracking-wider">Payments (Rs)</th>
                                                <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-800 uppercase tracking-wider">Balance (Rs)</th>
                                                <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-800 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="member-ledger-body" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                        <tfoot class="bg-gray-200">
                                            <tr>
                                                <td colspan="2" class="px-6 py-3 text-left text-sm font-semibold text-gray-800">Totals</td>
                                                <td id="ledger-total-paid" class="px-6 py-3 text-right text-sm font-semibold text-gray-800"></td>
                                                <td id="ledger-total-balance" class="px-6 py-3 text-right text-sm font-semibold text-gray-800"></td>
                                                <td class="px-6 py-3"></td> <!-- Empty cell for Actions column alignment -->
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                             <div id="ledger-placeholder" class="text-center py-4 text-gray-500">
                                Select a member to view their ledger.
                            </div>
                        </div>
                    </div>
                </div>
                <div id="backup-content" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div id="backup-status-container" class="space-y-4">
                            <!-- This content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Member Add/Edit Modal -->
    <div id="member-modal" class="modal-overlay hidden">
        <div class="modal-content no-scrollbar">
            <h2 id="modal-title" class="text-xl font-semibold mb-6">Add New Member</h2>
            <form id="member-form">
                <input type="hidden" id="member-id">
                <input type="hidden" id="original-join-date"> 
                <input type="hidden" id="original-admission-fee-payment-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="member-name" class="block text-sm font-medium text-gray-700">Full Name <span class="text-red-500">*</span></label>
                        <input type="text" id="member-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <p id="member-name-error" class="text-red-600 text-sm mt-1 hidden">Member name already exists.</p>
                    </div>
                     <div>
                        <label for="member-gender" class="block text-sm font-medium text-gray-700">Gender <span class="text-red-500">*</span></label>
                        <select id="member-gender" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="">-- Select --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                        <label for="member-mobile" class="block text-sm font-medium text-gray-700">Mobile Number <span class="text-red-500">*</span></label>
                        <input type="tel" id="member-mobile" required placeholder="e.g., 03331234567" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="member-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="member-email" placeholder="e.g., member@example.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="member-cnic" class="block text-sm font-medium text-gray-700">CNIC No.</label>
                        <input type="text" id="member-cnic" placeholder="XXXXX-XXXXXXX-X" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="member-admission-fee" class="block text-sm font-medium text-gray-700">Admission Fee (Rs)</label>
                        <input type="number" id="member-admission-fee" min="0" placeholder="e.g., 500" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="member-join-date" class="block text-sm font-medium text-gray-700">Join Date <span class="text-red-500">*</span></label>
                        <input type="date" id="member-join-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="member-payment-cycle-day" class="block text-sm font-medium text-gray-700">Monthly Payment Date <span class="text-red-500">*</span></label>
                        <input type="number" id="member-payment-cycle-day" required min="1" max="31" placeholder="1-31" title="The day of the month (1-31) the fee is due" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="member-fee" class="block text-sm font-medium text-gray-700">Monthly Fee (Rs) <span class="text-red-500">*</span></label>
                        <input type="number" id="member-fee" required min="0" placeholder="e.g., 2000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="member-status" class="block text-sm font-medium text-gray-700">Status <span class="text-red-500">*</span></label>
                        <select id="member-status" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="Active">Active</option> <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div id="log-initial-monthly-fee-container" class="mb-4 hidden">
                    <input type="checkbox" id="log-initial-monthly-fee" class="mr-2 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="log-initial-monthly-fee" class="text-sm font-medium text-gray-700">Log initial monthly fee as paid on join date?</label>
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="cancel-member-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" id="save-member-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Save Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Edit Modal -->
    <div id="payment-edit-modal" class="modal-overlay hidden">
        <div class="modal-content modal-content-sm no-scrollbar">
            <h2 id="payment-edit-modal-title" class="text-xl font-semibold mb-6">Edit Payment</h2>
            <form id="payment-edit-form">
                <input type="hidden" id="edit-payment-id">
                <input type="hidden" id="edit-payment-member-id">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Member: <span id="edit-payment-member-name-display" class="font-normal"></span></label>
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Applied to Period Starting: <span id="edit-payment-applied-period-display" class="font-normal"></span></label>
                </div>
                <div class="mb-4">
                    <label for="edit-payment-date" class="block text-sm font-medium text-gray-700">Payment Made On <span class="text-red-500">*</span></label>
                    <input type="date" id="edit-payment-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>


		<div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Payment Type:</label>
                    <p id="edit-payment-type-display" class="mt-1 block w-full px-3 py-2 border border-gray-200 bg-gray-50 text-gray-700 rounded-md shadow-sm sm:text-sm"></p>
                </div>
                <div class="mb-4">
                    <label for="edit-payment-amount" class="block text-sm font-medium text-gray-700">Amount (Rs) <span class="text-red-500">*</span></label>
                    <input type="number" id="edit-payment-amount" required min="0" step="any" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                     <button type="button" id="delete-payment-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete</button>
                     <button type="button" id="cancel-edit-payment-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                     <button type="submit" id="save-edit-payment-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ledger Add Payment Modal -->
    <div id="ledger-add-payment-modal" class="modal-overlay hidden">
        <div class="modal-content modal-content-sm no-scrollbar">
            <h2 class="text-xl font-semibold mb-6">Add Monthly Payment</h2>
            <form id="ledger-add-payment-form">
                <input type="hidden" id="ledger-add-payment-member-id">
                <input type="hidden" id="ledger-add-payment-period-start">
                <input type="hidden" id="ledger-add-payment-period-end">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Member: <span id="ledger-add-payment-member-name-display" class="font-normal"></span></label>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Payment For Period Starting: <span id="ledger-add-payment-period-display" class="font-normal"></span></label>
                </div>
                <div class="mb-4">
                    <label for="ledger-new-payment-date" class="block text-sm font-medium text-gray-700">Payment Made On <span class="text-red-500">*</span></label>
                    <input type="date" id="ledger-new-payment-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="ledger-new-payment-amount" class="block text-sm font-medium text-gray-700">Amount (Rs) <span class="text-red-500">*</span></label>
                    <input type="number" id="ledger-new-payment-amount" required min="0" step="any" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="cancel-ledger-add-payment-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Add Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Write-Off Add/Edit Modal -->
    <div id="writeoff-modal" class="modal-overlay hidden">
        <div class="modal-content modal-content-sm no-scrollbar">
            <h2 id="writeoff-modal-title" class="text-xl font-semibold mb-6">Add Write-Off</h2>
            <form id="writeoff-form">
                <input type="hidden" id="writeoff-id">
                <input type="hidden" id="writeoff-member-id">
                <input type="hidden" id="writeoff-period-start-date">
                <input type="hidden" id="writeoff-period-end-date">
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Member: <span id="writeoff-member-name-display" class="font-normal"></span></label>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">For Period: <span id="writeoff-period-display" class="font-normal"></span></label>
                </div>
                <div class="mb-4">
                    <label for="writeoff-date" class="block text-sm font-medium text-gray-700">Write-Off Date <span class="text-red-500">*</span></label>
                    <input type="date" id="writeoff-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="writeoff-amount" class="block text-sm font-medium text-gray-700">Amount to Write Off (Rs) <span class="text-red-500">*</span></label>
                    <input type="number" id="writeoff-amount" required min="0" step="any" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="writeoff-notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                    <textarea id="writeoff-notes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="delete-writeoff-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md hidden">Delete</button>
                    <button type="button" id="cancel-writeoff-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" id="save-writeoff-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Save Write-Off</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Member Data History Modal -->
    <!-- Member Data History Modal -->
    <div id="member-data-history-modal" class="modal-overlay hidden">
        <div class="modal-content modal-content-lg no-scrollbar">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl font-semibold">History: <span id="history-modal-member-name" class="text-indigo-600"></span></h2>
                    <p class="text-sm text-gray-600">Member Since: <span id="history-modal-join-date" class="font-medium"></span></p>
                </div>
                <div class="text-right text-sm ml-4">
                    <p><strong>Current Status:</strong> <span id="history-modal-current-status"></span></p>
                    <p><strong>Current Fee:</strong> <span id="history-modal-current-fee"></span></p>
                    <p><strong>Current Payment date:</strong> <span id="history-modal-current-payment-day"></span></p>
                </div>
            </div>

            <!-- Changed space-y-3 to space-y-2 for more compactness -->
            <div id="member-data-history-items-container" class="max-h-[55vh] overflow-y-auto space-y-2">
            </div>

            <div class="flex justify-end mt-6">
                <button type="button" id="close-member-data-history-modal-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>

    <div id="status-history-modal" class="modal-overlay hidden">
        <div class="modal-content modal-content-md no-scrollbar">
            <h2 class="text-xl font-semibold mb-6">Member Status History</h2>
            <div id="status-history-member-name" class="mb-4 text-lg font-medium text-gray-800"></div>
            <div class="max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Effective From</th>
                        </tr>
                    </thead>
                    <tbody id="status-history-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-status-history-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    <!-- Edit History Effective Date Modal  <<-- ADD THIS ENTIRE BLOCK HERE -->
    <div id="edit-history-effective-date-modal" class="modal-overlay hidden">
        <div class="modal-content modal-content-sm no-scrollbar">
            <h2 class="text-xl font-semibold mb-6">Edit Effective Date</h2>
            <form id="edit-history-effective-date-form">
                <input type="hidden" id="edit-history-member-id">
                <input type="hidden" id="edit-history-entry-id">
                <input type="hidden" id="edit-history-type">

                <div class="mb-4">
                    <label for="edit-history-new-effective-date" class="block text-sm font-medium text-gray-700">New Effective Date <span class="text-red-500">*</span></label>
                    <input type="date" id="edit-history-new-effective-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <p id="edit-history-date-error" class="text-red-600 text-sm mt-1 hidden"></p>


                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="cancel-edit-history-date-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button type="submit" id="save-edit-history-date-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-sm">
             <h2 id="confirmation-title" class="text-lg font-semibold mb-4">Confirm Action</h2>
             <p id="confirmation-message" class="text-gray-700 mb-6">Are you sure?</p>
             <div class="flex justify-end space-x-3">
                 <button id="confirm-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                 <button id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Confirm</button>
             </div>
        </div>
    </div>

    <script>
        // --- Constants and Global Variables ---
        // const APP_VERSION = 'v17_ledger_year_nav_sqlite'; // No longer used for localStorage keys
        // const MEMBERS_KEY = `gymMembers_${APP_VERSION}`;
        // const PAYMENTS_KEY = `gymPayments_${APP_VERSION}`;
        // const WRITEOFFS_KEY = `gymWriteOffs_${APP_VERSION}`;

        // These will be populated by API calls
        let members = [];
        let payments = [];
        let writeOffs = [];

        let salesChartInstance = null;
        let currentSort = { column: 'name', direction: 'asc' };
        let activeMemberFilters = ['active'];
        let currentGenderFilter = 'all';
        let currentChartYear = new Date().getFullYear();
        let rawExpectedMonthlyRevenue = 0;
        let rawFeesOverdue = 0;
        let isSalesChartBlurred = true;
        let isExpectedRevenueRevealed = false;
        let isFeesOverdueRevealed = false;
        let currentHomePaymentsGenderFilter = 'all';
        let currentHomeJoinsGenderFilter = 'all';
        let currentPage = 1;
        const itemsPerPage = 20;
        let selectedLedgerMemberId = null;
        let selectedLedgerViewYear = new Date().getFullYear(); // For ledger year navigation


        // --- DOM Elements ---
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const originalAdmissionFeePaymentIdInput = document.getElementById('original-admission-fee-payment-id');

        // Home Tab Elements
        const recentPaymentsListEl = document.getElementById('recent-payments-list');
        const recentJoinsListEl = document.getElementById('recent-joins-list');
        const homePaymentsGenderFilterControls = document.getElementById('home-payments-gender-filter-controls');
        const homeJoinsGenderFilterControls = document.getElementById('home-joins-gender-filter-controls');

        // Revenue Elements
        const totalActiveMembersEl = document.getElementById('total-active-members');
        const expectedMonthlyRevenueEl = document.getElementById('expected-monthly-revenue');
        const feesOverdueEl = document.getElementById('fees-overdue');
        const salesChartCanvas = document.getElementById('salesChart');
        const genderFilterControls = document.getElementById('gender-filter-controls');
        const currentChartYearDisplay = document.getElementById('current-chart-year-display');
        const prevYearBtn = document.getElementById('prev-year-btn');
        const nextYearBtn = document.getElementById('next-year-btn');
        const revealRevenueBtn = document.getElementById('reveal-revenue-btn');
        const revealOverdueBtn = document.getElementById('reveal-overdue-btn');
        const toggleChartBlurBtn = document.getElementById('toggle-chart-blur-btn');
        const salesChartCanvasContainer = document.getElementById('sales-chart-canvas-container');

        // Memberships Elements
        const addMemberBtn = document.getElementById('add-member-btn');
        const memberModal = document.getElementById('member-modal');
        const memberForm = document.getElementById('member-form');
        const cancelMemberBtn = document.getElementById('cancel-member-btn');
        const modalTitle = document.getElementById('modal-title');
        const memberIdInput = document.getElementById('member-id');
        const originalJoinDateInput = document.getElementById('original-join-date');
        const memberNameInput = document.getElementById('member-name');
        const memberNameError = document.getElementById('member-name-error');
        const memberGenderInput = document.getElementById('member-gender');
        const memberMobileInput = document.getElementById('member-mobile');
        const memberEmailInput = document.getElementById('member-email');
        const memberCnicInput = document.getElementById('member-cnic');
        const memberAdmissionFeeInput = document.getElementById('member-admission-fee');
        const memberJoinDateInput = document.getElementById('member-join-date');
        const memberPaymentCycleDayInput = document.getElementById('member-payment-cycle-day');
        const memberFeeInput = document.getElementById('member-fee');
        const memberStatusInput = document.getElementById('member-status');
        const logInitialMonthlyFeeContainer = document.getElementById('log-initial-monthly-fee-container');
        const logInitialMonthlyFeeCheckbox = document.getElementById('log-initial-monthly-fee');
        const membersTableBody = document.getElementById('members-table-body');
        const memberSearchInput = document.getElementById('member-search');
        const membersThead = document.querySelector('#memberships-content thead');
        const memberFilterTagsContainer = document.getElementById('member-filter-tags-container');
        const memberFilterCountEl = document.getElementById('member-filter-count');
        const membersPaginationControlsEl = document.getElementById('members-pagination-controls');

        // Ledger Elements
        const ledgerMemberInput = document.getElementById('ledger-member-input');
        const viewMemberHistoryBtn = document.getElementById('view-member-history-btn');
        const editLedgerMemberBtn = document.getElementById('edit-ledger-member-btn'); // New button
        const clearLedgerSelectionBtn = document.getElementById('clear-ledger-selection-btn');
        const ledgerMemberSuggestionsEl = document.getElementById('ledger-member-suggestions');
        const memberLedgerBody = document.getElementById('member-ledger-body');
        const ledgerDetailsContainer = document.getElementById('ledger-details-container');
        const ledgerPlaceholder = document.getElementById('ledger-placeholder');
        const ledgerTotalPaidEl = document.getElementById('ledger-total-paid');
        const ledgerTotalBalanceEl = document.getElementById('ledger-total-balance');
        const ledgerMemberOverdueContainerEl = document.getElementById('ledger-member-overdue-container');
        const ledgerMemberOverdueAmountEl = document.getElementById('ledger-member-overdue-amount');


        // START: Ledger Controls Header (Year Nav + Overdue) DOM Elements
        const ledgerControlsHeaderEl = document.getElementById('ledger-controls-header');
        const ledgerPrevYearBtn = document.getElementById('ledger-prev-year-btn');
        const currentLedgerYearDisplayEl = document.getElementById('current-ledger-year-display');
        const ledgerNextYearBtn = document.getElementById('ledger-next-year-btn');
        // END: Ledger Controls Header DOM Elements


        // Payment Edit Modal Elements
        const paymentEditModal = document.getElementById('payment-edit-modal');
        const paymentEditForm = document.getElementById('payment-edit-form');
        const editPaymentIdInput = document.getElementById('edit-payment-id');
        const editPaymentMemberIdInput = document.getElementById('edit-payment-member-id');
        const editPaymentAppliedPeriodDisplay = document.getElementById('edit-payment-applied-period-display');
        const editPaymentDateInput = document.getElementById('edit-payment-date');
	    const editPaymentTypeDisplay = document.getElementById('edit-payment-type-display');
        const editPaymentAmountInput = document.getElementById('edit-payment-amount');
        const cancelEditPaymentBtn = document.getElementById('cancel-edit-payment-btn');
        const deletePaymentBtn = document.getElementById('delete-payment-btn');
        const editPaymentMemberNameDisplay = document.getElementById('edit-payment-member-name-display');


        // Ledger Add Payment Modal Elements
        const ledgerAddPaymentModal = document.getElementById('ledger-add-payment-modal');
        const ledgerAddPaymentForm = document.getElementById('ledger-add-payment-form');
        const ledgerAddPaymentMemberIdInput = document.getElementById('ledger-add-payment-member-id');
        const ledgerAddPaymentPeriodStartInput = document.getElementById('ledger-add-payment-period-start');
        const ledgerAddPaymentPeriodEndInput = document.getElementById('ledger-add-payment-period-end');
        const ledgerNewPaymentDateInput = document.getElementById('ledger-new-payment-date'); 
        const ledgerNewPaymentAmountInput = document.getElementById('ledger-new-payment-amount');
        const cancelLedgerAddPaymentBtn = document.getElementById('cancel-ledger-add-payment-btn');
        const ledgerAddPaymentMemberNameDisplay = document.getElementById('ledger-add-payment-member-name-display');
        const ledgerAddPaymentPeriodDisplay = document.getElementById('ledger-add-payment-period-display');


        // WriteOff Modal Elements
        const writeoffModal = document.getElementById('writeoff-modal');
        const writeoffForm = document.getElementById('writeoff-form');
        const writeoffModalTitle = document.getElementById('writeoff-modal-title');
        const writeoffIdInput = document.getElementById('writeoff-id');
        const writeoffMemberIdInput = document.getElementById('writeoff-member-id');
        const writeoffPeriodStartDateInput = document.getElementById('writeoff-period-start-date');
        const writeoffPeriodEndDateInput = document.getElementById('writeoff-period-end-date');
        const writeoffAmountInput = document.getElementById('writeoff-amount');
        const writeoffDateInput = document.getElementById('writeoff-date');
        const writeoffNotesInput = document.getElementById('writeoff-notes');
        const cancelWriteoffBtn = document.getElementById('cancel-writeoff-btn');
        const saveWriteoffBtn = document.getElementById('save-writeoff-btn');
        const writeoffMemberNameDisplay = document.getElementById('writeoff-member-name-display');
        const writeoffPeriodDisplay = document.getElementById('writeoff-period-display');
        const deleteWriteoffBtn = document.getElementById('delete-writeoff-btn');

        // Member Data History Modal Elements
        const memberDataHistoryModal = document.getElementById('member-data-history-modal');
        const historyModalMemberNameEl = document.getElementById('history-modal-member-name');
        const historyModalJoinDateEl = document.getElementById('history-modal-join-date');
        const historyModalCurrentStatusEl = document.getElementById('history-modal-current-status');
        const historyModalCurrentFeeEl = document.getElementById('history-modal-current-fee');
        const historyModalCurrentPaymentDayEl = document.getElementById('history-modal-current-payment-day');
        const memberDataHistoryItemsContainerEl = document.getElementById('member-data-history-items-container');
        const closeMemberDataHistoryModalBtn = document.getElementById('close-member-data-history-modal-btn');

        // Status History Modal Elements
        const statusHistoryModal = document.getElementById('status-history-modal');
        const statusHistoryMemberNameEl = document.getElementById('status-history-member-name');
        const statusHistoryTableBody = document.getElementById('status-history-table-body');
        const closeStatusHistoryBtn = document.getElementById('close-status-history-btn');

        // Confirmation Modal Elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationTitle = document.getElementById('confirmation-title');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        let currentActionCallback = null;
         // Edit History Effective Date Modal Elements
         const editHistoryEffectiveDateModal = document.getElementById('edit-history-effective-date-modal');
        const editHistoryEffectiveDateForm = document.getElementById('edit-history-effective-date-form');
        const editHistoryMemberIdInput = document.getElementById('edit-history-member-id');
        const editHistoryEntryIdInput = document.getElementById('edit-history-entry-id');
        const editHistoryTypeInput = document.getElementById('edit-history-type');
        const editHistoryNewEffectiveDateInput = document.getElementById('edit-history-new-effective-date');
        const cancelEditHistoryDateBtn = document.getElementById('cancel-edit-history-date-btn');
        const saveEditHistoryDateBtn = document.getElementById('save-edit-history-date-btn');
        const editHistoryDateError = document.getElementById('edit-history-date-error');
        const backupStatusContainer = document.getElementById('backup-status-container');
        const backupNotification = document.getElementById('backup-notification');


         // --- ADD THIS NEW FUNCTION ---
        /**
         * Converts a 24-hour time string (e.g., "17:30") to a 12-hour AM/PM format (e.g., "5:30 PM").
         * @param {string} timeString - The time string in "HH:mm" format.
         * @returns {string} The formatted 12-hour time string.
         */
        function formatTime12Hour(timeString) {
            if (!timeString) return '';
            // Split the time string into hours and minutes
            const [hourString, minute] = timeString.split(':');
            let hour = parseInt(hourString, 10);
            
            // Determine AM or PM
            const ampm = hour >= 12 ? 'PM' : 'AM';
            
            // Convert hour to 12-hour format
            hour = hour % 12;
            hour = hour ? hour : 12; // The hour '0' should be '12'
            
            return `${hour}:${minute} ${ampm}`;
        }
        
        // --- API Helper ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {}
            };
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(`/api${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`API Error (${response.status}): ${errorData.error || errorData.message}`);
                }
                if (response.status === 204) return null; // No content
                return response.json();
            } catch (error) {
                console.error(`Error calling ${method} ${endpoint}:`, error);
                alert(`An error occurred: ${error.message}`);
                throw error; // Re-throw to be caught by caller if needed
            }
        }

        // --- Utility Functions ---

        const parseLocalDate = (dateString) => { 
            if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return null;
            }
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                // Use UTC to avoid timezone issues if dates are consistently YYYY-MM-DD
                const date = new Date(Date.UTC(year, month - 1, day));
                 if (date.getUTCFullYear() !== year || date.getUTCMonth() !== month - 1 || date.getUTCDate() !== day) {
                    console.warn("Invalid date components provided (UTC check):", dateString);
                    return null;
                }
                return date;
            } catch (e) {
                console.error("Error parsing date string:", dateString, e);
                return null;
            }
        };

        const formatDate = (dateInput) => { 
            if (!dateInput) return 'N/A';
            let date;
            if (dateInput instanceof Date) {
                date = dateInput;
            } else if (typeof dateInput === 'string') {
                date = parseLocalDate(dateInput);
            }

            if (!date || isNaN(date.getTime())) {
                 return 'Invalid Date';
             }

            const day = String(date.getUTCDate()).padStart(2, '0');
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const month = monthNames[date.getUTCMonth()];
            const year = date.getUTCFullYear();
            return `${day}-${month}-${year}`;
        };
        
        const toInputDateString = (dateObj) => { 
            if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj.getTime())) return '';
            const year = dateObj.getUTCFullYear();
            const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };


        const getTodayInputDate = () => {
             const today = new Date(); 
             const year = today.getFullYear(); // Use local year for "today" context
             const month = String(today.getMonth() + 1).padStart(2, '0');
             const day = String(today.getDate()).padStart(2, '0');
             return `${year}-${month}-${day}`;
        }

        const formatCurrency = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) amount = 0;
            return `${amount.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`; 
        };

        // saveData function is removed, data persistence handled by API calls.
        // async function saveData() { /* No longer needed */ }

        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        // --- Member Overdue Calculation Helper ---
        const getMemberOverdueAmount = (memberId) => {
            const member = members.find(m => m.id === memberId);
            if (!member) return 0;

            const today = parseLocalDate(getTodayInputDate());
            if (!today) {
                console.error("Failed to parse today's date in getMemberOverdueAmount for member:", memberId);
                return 0;
            }

            let projectionEndDateForLedger = new Date(today); // Default to today
            const currentStatusOnToday = getEffectiveValue(member.statusHistory, today, 'Inactive');

            if (currentStatusOnToday === 'Active') {
                const paymentCycleDay = parseInt(getEffectiveValue(member.paymentCycleDayHistory, today, 0));
                const joinDateObj = parseLocalDate(member.joinDate);

                if (joinDateObj && paymentCycleDay >= 1 && paymentCycleDay <= 31) {
                    let cycleActualStartDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), paymentCycleDay));
                    if (today.getUTCDate() < paymentCycleDay) {
                        cycleActualStartDate.setUTCMonth(cycleActualStartDate.getUTCMonth() - 1);
                    }
                    if (cycleActualStartDate < joinDateObj) {
                        cycleActualStartDate = new Date(joinDateObj);
                    }

                    let cycleNaturalEndDate = new Date(Date.UTC(cycleActualStartDate.getUTCFullYear(), cycleActualStartDate.getUTCMonth() + 1, paymentCycleDay));
                    cycleNaturalEndDate = addDays(cycleNaturalEndDate, -1);

                    if (cycleNaturalEndDate < today && cycleActualStartDate <= today) {
                         let tempEndDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), paymentCycleDay));
                         if (today.getUTCDate() >= paymentCycleDay) {
                             tempEndDate.setUTCMonth(tempEndDate.getUTCMonth() + 1);
                         }
                         cycleNaturalEndDate = addDays(tempEndDate, -1);
                    }

                    if (cycleNaturalEndDate >= today) {
                        projectionEndDateForLedger = cycleNaturalEndDate;
                    }
                }
            }

            const ledgerEntries = generateLedgerEntries(member.id, toInputDateString(projectionEndDateForLedger));
            let totalMembershipFeesDue = 0;
            let totalMonthlyFeePaymentsAndWriteOffs = 0;

            ledgerEntries.forEach(entry => {
                const entryStartDateObj = parseLocalDate(entry.periodStartDate);
                const entryEndDateObj = parseLocalDate(entry.periodEndDate);

                if (!entryStartDateObj || !entryEndDateObj) return;

                // Sum dues for periods that have ended before today, or the current period that includes today.
                if (entryEndDateObj < today || (entryStartDateObj <= today && entryEndDateObj >= today)) {
                    totalMembershipFeesDue += entry.feesDue;
                    entry.payments.forEach(p => {
                        if (p.paymentType === 'Monthly Fee') totalMonthlyFeePaymentsAndWriteOffs += p.amount;
                    });
                    entry.writeOffs.forEach(w => totalMonthlyFeePaymentsAndWriteOffs += w.amount);
                }
            });

            const balance = totalMembershipFeesDue - totalMonthlyFeePaymentsAndWriteOffs;
            return Math.max(0, balance); // Overdue amount cannot be negative
        };


        // --- Date Helper Functions for Ledger ---
        const addDays = (date, days) => {
            const result = new Date(date);
            result.setUTCDate(result.getUTCDate() + days);
            return result;
        };

        const daysBetween = (startDate, endDate) => { 
            if (!startDate || !endDate) return 0;
            const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) +1; 
            return diffDays;
        };

        const getEffectiveValue = (historyArray, targetDate, defaultValue = null) => {
            if (!historyArray || historyArray.length === 0) return defaultValue;
            const targetDateObj = (targetDate instanceof Date) ? targetDate : parseLocalDate(targetDate);
            if (!targetDateObj) return defaultValue;

            let effectiveEntry = null;
            for (const entry of historyArray) {
                const effectiveDateObj = parseLocalDate(entry.effectiveDate);
                if (effectiveDateObj && effectiveDateObj <= targetDateObj) {
                    if (!effectiveEntry || effectiveDateObj > parseLocalDate(effectiveEntry.effectiveDate)) {
                        effectiveEntry = entry;
                    } else if (effectiveDateObj.getTime() === parseLocalDate(effectiveEntry.effectiveDate).getTime()) {
                        // Tie-break with ID if dates are identical
                        if (entry.id && effectiveEntry.id && entry.id > effectiveEntry.id) { // Assuming higher ID is "later" if same date
                             effectiveEntry = entry;
                        }
                    }
                }
            }
            return effectiveEntry ? effectiveEntry.value : defaultValue;
        };
        
        const getLatestValueFromHistory = (historyArray, defaultValue = null) => {
            if (!historyArray || historyArray.length === 0) return defaultValue;
            // Ensure historyArray is sorted by effectiveDate then by ID
            const sortedHistory = [...historyArray].sort((a, b) => {
                const dateA = parseLocalDate(a.effectiveDate);
                const dateB = parseLocalDate(b.effectiveDate);
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                if (dateB.getTime() === dateA.getTime()) {
                     return (b.id && a.id && b.id > a.id) ? 1 : -1; 
                }
                return dateB - dateA; // Most recent date first
            });
            return sortedHistory[0].value;
        };

       function updateOrAddHistoryEntry(member, historyKey, newValue, effectiveDate) {
            if (!member[historyKey]) member[historyKey] = [];

            let updatedOrAddedEntryId = null;

            const existingEntryIndex = member[historyKey].findIndex(entry => entry.effectiveDate === effectiveDate);

            if (existingEntryIndex > -1) {
                // If an entry exists for this exact date, update its value.
                // The backend will handle proper storage if multiple entries on same date occur (though UI aims to avoid this)
                member[historyKey][existingEntryIndex].value = newValue;
                updatedOrAddedEntryId = member[historyKey][existingEntryIndex].id;
            } else {
                // Add a new entry if no entry exists for this date
                const newEntry = { id: generateId(), value: newValue, effectiveDate: effectiveDate };
                member[historyKey].push(newEntry);
                updatedOrAddedEntryId = newEntry.id;
            }

            // Sort history: primarily by effectiveDate, secondarily by ID for tie-breaking
            member[historyKey].sort((a, b) => {
                const dateA = parseLocalDate(a.effectiveDate);
                const dateB = parseLocalDate(b.effectiveDate);
                
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1; 
                if (!dateB) return -1;

                if (dateA.getTime() === dateB.getTime()) {
                    return (a.id && b.id) ? a.id.localeCompare(b.id) : 0;
                }
                return dateA - dateB;
            });

            // Remove redundant entries (consecutive entries with the same value)
            // This should happen after sorting
            if (updatedOrAddedEntryId) { // Only run if an update or add happened
                for (let i = member[historyKey].length - 1; i > 0; i--) {
                    if (member[historyKey][i].value === member[historyKey][i - 1].value) {
                        // If the one being removed is the one we just added/updated,
                        // and it's redundant with the PREVIOUS one, remove the current one.
                        // Otherwise, if the one before is redundant with the one before it, remove the one before.
                        // Simplified: just remove the current one if it's same as previous.
                        // The updateOrAddHistoryEntry is called when FORM changes, so this should catch new redundancies.
                         if (member[historyKey][i].effectiveDate === member[historyKey][i-1].effectiveDate) {
                            // If dates are identical, prefer entry with "higher" ID or keep the one just modified
                            if (member[historyKey][i].id !== updatedOrAddedEntryId) { // If the duplicate is NOT the one we just touched
                                member[historyKey].splice(i, 1);
                            } else if (member[historyKey][i-1].id !== updatedOrAddedEntryId) { // If the PREVIOUS one is the duplicate
                                member[historyKey].splice(i-1, 1);
                                i--; // Adjust index as array shifted
                            }
                         } else { // Dates are different, but values are same. Remove the one at `i`.
                            member[historyKey].splice(i, 1);
                         }
                    }
                }
                // Special case: if the very first entry became redundant with a new one, remove it (should be rare)
                 if (member[historyKey].length > 1 && member[historyKey][0].value === member[historyKey][1].value) {
                    member[historyKey].splice(0,1);
                 }
            }
        }

        // --- Ledger State Management Functions ---
        function updateLedgerControlsVisibility() {
            const memberIsSelected = !!selectedLedgerMemberId;
            viewMemberHistoryBtn.classList.toggle('hidden', !memberIsSelected);
            editLedgerMemberBtn.classList.toggle('hidden', !memberIsSelected); // Toggle new button
            if (clearLedgerSelectionBtn) clearLedgerSelectionBtn.classList.toggle('hidden', !memberIsSelected);
            ledgerControlsHeaderEl.classList.toggle('hidden', !memberIsSelected);
            // The ledger table/placeholder visibility is handled by renderMemberLedger itself.
        }

        function resetLedgerSelectionAndDisplay() {
            ledgerMemberInput.value = '';
            ledgerMemberInput.classList.remove('input-success');
            ledgerMemberInput.removeAttribute('data-selected-member-id');
            selectedLedgerMemberId = null;
            // selectedLedgerViewYear = new Date().getFullYear(); // Optional: reset year to current
            renderMemberLedger(null); // Clears table, shows placeholder
            updateLedgerControlsVisibility();
            hideSuggestions(ledgerMemberSuggestionsEl);
        }

        // --- Tab Navigation ---
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tab = link.getAttribute('data-tab');

                // Update tab visual state
                tabLinks.forEach(l => l.classList.remove('tab-active', 'bg-indigo-100'));
                link.classList.add('tab-active', 'bg-indigo-100');

                // Show/hide tab content
                tabContents.forEach(content => {
                    content.id === `${tab}-content`
                        ? content.classList.remove('hidden')
                        : content.classList.add('hidden');
                });

                // Clear member search input if not on memberships tab
                if (tab !== 'memberships') {
                    memberSearchInput.value = '';
                }

                // Handle specific tab logic
                if (tab === 'revenue') {
                    updateRevenueMetrics()
                    renderSalesChart(currentChartYear);
                } else if (tab === 'home') {
                    renderHomeTabContent();
                } else if (tab === 'memberships') {
                    renderMembersTable();
                } else if (tab === 'backup') {
                    renderBackupTab();    
                } else if (tab === 'ledger') {
                    currentPage = 1; // Reset page when switching to ledger or other tabs
                    if (selectedLedgerMemberId) { // If a member ID is stored
                        const member = members.find(m => m.id === selectedLedgerMemberId);
                        if (member) { // And the member still exists
                            ledgerMemberInput.value = member.name; // Set the input text
                            ledgerMemberInput.classList.add('input-success');
                            ledgerMemberInput.dataset.selectedMemberId = selectedLedgerMemberId; // Restore data attribute
                            renderMemberLedger(selectedLedgerMemberId, selectedLedgerViewYear);
                        } else { // Member was deleted or not found
                            resetLedgerSelectionAndDisplay(); // Clear everything
                        }
                    } else { // No member ID stored, ensure clean state for ledger input and display
                        resetLedgerSelectionAndDisplay(); // Ensures input is clear and placeholder shown
                    }
                    updateLedgerControlsVisibility(); // Always update visibility for ledger tab controls
                }
            });
        });

        // --- Gender Filter Logic (Revenue) ---
        genderFilterControls.addEventListener('click', (e) => {
            const button = e.target.closest('.gender-filter-btn');
            if (!button) return;

            const gender = button.dataset.gender;
            currentGenderFilter = gender;

            genderFilterControls.querySelectorAll('.gender-filter-btn').forEach(btn => {
                btn.classList.remove('gender-filter-active');
            });
            button.classList.add('gender-filter-active');

            updateRevenueMetrics();
            renderSalesChart(currentChartYear);
        });

        // --- Revenue Tab Metrics Logic ---
        const updateRevenueMetrics = () => {
            let activeMembersCount = 0;
            let expectedMonthlyRevenueTotal = 0;
            const todayStr = getTodayInputDate();

            members.forEach(member => {
                if (currentGenderFilter !== 'all' && member.gender !== currentGenderFilter) {
                    return;
                }
                const currentStatus = getEffectiveValue(member.statusHistory, todayStr, 'Inactive');
                if (currentStatus === 'Active') {
                    activeMembersCount++;
                    expectedMonthlyRevenueTotal += parseFloat(getEffectiveValue(member.monthlyFeeHistory, todayStr, 0)) || 0;
                }
            });

            totalActiveMembersEl.textContent = activeMembersCount;
            rawExpectedMonthlyRevenue = expectedMonthlyRevenueTotal;
            rawFeesOverdue = calculateTotalOverdueForAllMembers(currentGenderFilter);

            expectedMonthlyRevenueEl.textContent = isExpectedRevenueRevealed ? `${formatCurrency(rawExpectedMonthlyRevenue)} Rs` : "•••••• Rs";
            feesOverdueEl.textContent = isFeesOverdueRevealed ? `${formatCurrency(rawFeesOverdue)} Rs` : "•••••• Rs";
        };

        revealRevenueBtn.addEventListener('click', () => {
            isExpectedRevenueRevealed = !isExpectedRevenueRevealed;
            revealRevenueBtn.querySelector('i').className = `fas ${isExpectedRevenueRevealed ? 'fa-eye' : 'fa-eye-slash'}`;
            revealRevenueBtn.title = isExpectedRevenueRevealed ? 'Hide Revenue' : 'Reveal Revenue';
            updateRevenueMetrics();
        });

        revealOverdueBtn.addEventListener('click', () => {
            isFeesOverdueRevealed = !isFeesOverdueRevealed;
            revealOverdueBtn.querySelector('i').className = `fas ${isFeesOverdueRevealed ? 'fa-eye' : 'fa-eye-slash'}`;
            revealOverdueBtn.title = isFeesOverdueRevealed ? 'Hide Overdue' : 'Reveal Overdue';
            updateRevenueMetrics();
        });

        toggleChartBlurBtn.addEventListener('click', () => {
            isSalesChartBlurred = !isSalesChartBlurred;
            salesChartCanvasContainer.classList.toggle('blurred', isSalesChartBlurred);
            toggleChartBlurBtn.querySelector('i').className = `fas ${isSalesChartBlurred ? 'fa-eye-slash' : 'fa-eye'} fa-fw text-lg`;
            toggleChartBlurBtn.title = isSalesChartBlurred ? 'Unblur chart' : 'Blur chart';
        });


        // --- Sales Chart Logic ---
        const renderSalesChart = (year) => {
            currentChartYearDisplay.textContent = year;

            const salesByMonth = {};
            for (let i = 0; i < 12; i++) {
                const monthStr = String(i + 1).padStart(2, '0');
                const yearMonth = `${year}-${monthStr}`;
                salesByMonth[yearMonth] = { admission: 0, monthly: 0 };
            }

            // Iterate over all payments and filter/aggregate in one go
            payments.forEach(payment => {
                // Only include 'Admission Fee' or 'Monthly Fee' types
                if (payment.paymentType !== 'Admission Fee' && payment.paymentType !== 'Monthly Fee') {
                    return; // Skip this payment
                }

                // Apply gender filter
                if (currentGenderFilter !== 'all') {
                    const member = members.find(m => m.id === payment.memberId);
                    if (!member || member.gender !== currentGenderFilter) {
                        return; // Skip this payment
                    }
                }

                // Use appliedToPeriodStartDate for year filtering and month aggregation
                const appliedDateObj = parseLocalDate(payment.appliedToPeriodStartDate);
                if (!appliedDateObj) {
                    // console.warn(`Payment ID ${payment.id} has no valid appliedToPeriodStartDate. Skipping for sales chart.`);
                    return; // Skip if no valid applied date
                }

                const appliedYear = appliedDateObj.getUTCFullYear();
                if (appliedYear !== year) {
                    return; // Skip if not for the selected chart year
                }

                // Aggregate sales based on the month of appliedToPeriodStartDate
                try {
                    const yearMonth = `${appliedDateObj.getUTCFullYear()}-${String(appliedDateObj.getUTCMonth() + 1).padStart(2, '0')}`;
                    const amount = parseFloat(payment.amount) || 0;

                    if (salesByMonth[yearMonth]) { // This should always be true due to pre-initialization
                        if (payment.paymentType === 'Admission Fee') {
                            salesByMonth[yearMonth].admission += amount;
                        } else if (payment.paymentType === 'Monthly Fee') { // Specifically check for 'Monthly Fee'
                            salesByMonth[yearMonth].monthly += amount;
                        }
                    } // No 'else' needed as salesByMonth is pre-filled for the target 'year'
                } catch (e) { console.error("Chart data aggregation error:", payment, e); }
            });

            const chartLabels = Object.keys(salesByMonth).map(monthKey => {
                const [y, m] = monthKey.split('-');
                return new Date(Date.UTC(parseInt(y), parseInt(m) - 1, 1)).toLocaleString('default', { month: 'short', timeZone: 'UTC' });
            });
            const admissionData = Object.values(salesByMonth).map(data => data.admission);
            const monthlyFeeData = Object.values(salesByMonth).map(data => data.monthly);

            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            const ctx = salesChartCanvas.getContext('2d');
            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Admission Fees', data: admissionData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)', stack: 'Stack 0',
                        },
                        {
                            label: 'Monthly Fees', data: monthlyFeeData, // Changed label
                            backgroundColor: 'rgba(34, 197, 94, 0.7)', stack: 'Stack 0',
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, stacked: true, ticks: { callback: value => `${formatCurrency(value)} Rs` }, grace: '10%' },
                        x: { stacked: true, grid: { display: false } }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index', intersect: false,
                            callbacks: {
                                label: ctx => ctx.parsed.y !== null ? `${ctx.dataset.label || ''}: ${formatCurrency(ctx.parsed.y)} Rs` : null,
                                footer: items => {
                                    let sum = 0;
                                    items.forEach(item => { if (item.chart.isDatasetVisible(item.datasetIndex) && item.parsed.y !== null) sum += item.parsed.y; });
                                    return items.length > 1 && sum > 0 ? `Total Revenue: ${formatCurrency(sum)} Rs` : '';
                                }
                            }
                        },
                        legend: { position: 'top', onClick: (e, item, legend) => { legend.chart.setDatasetVisibility(item.datasetIndex, !legend.chart.isDatasetVisible(item.datasetIndex)); legend.chart.update(); }}
                    },
                    interaction: { intersect: false, mode: 'index' },
                }
            });
        };

        prevYearBtn.addEventListener('click', () => { currentChartYear--; renderSalesChart(currentChartYear); });
        nextYearBtn.addEventListener('click', () => { currentChartYear++; renderSalesChart(currentChartYear); });


        const getMemberOverdueDetails = (memberId) => {
            const member = members.find(m => m.id === memberId);
            if (!member) return { overdueAmount: 0, daysOverdue: 0 };

            const today = parseLocalDate(getTodayInputDate());
            if (!today) {
                console.error("Failed to parse today's date in getMemberOverdueDetails for member:", memberId);
                return { overdueAmount: 0, daysOverdue: 0 };
            }

            // Determine projection end date (consistent with previous logic, to cover current/upcoming periods)
            let projectionEndDateForCalculation = new Date(today);
            const currentStatusOnToday = getEffectiveValue(member.statusHistory, today, 'Inactive');

            if (currentStatusOnToday === 'Active') {
                const paymentCycleDay = parseInt(getEffectiveValue(member.paymentCycleDayHistory, today, 1));
                const joinDateObj = parseLocalDate(member.joinDate);

                if (joinDateObj && paymentCycleDay >= 1 && paymentCycleDay <= 31) {
                    let cycleActualStartDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), paymentCycleDay));
                    if (today.getUTCDate() < paymentCycleDay) {
                        cycleActualStartDate.setUTCMonth(cycleActualStartDate.getUTCMonth() - 1);
                    }
                    cycleActualStartDate = new Date(Math.max(cycleActualStartDate.getTime(), joinDateObj.getTime()));
                    
                    let cycleNaturalEndDate = addDays(new Date(Date.UTC(cycleActualStartDate.getUTCFullYear(), cycleActualStartDate.getUTCMonth() + 1, paymentCycleDay)), -1);
                    
                    if (cycleNaturalEndDate < today && cycleActualStartDate <= today) {
                         let tempEndDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), paymentCycleDay));
                         if (today.getUTCDate() >= paymentCycleDay) {
                             tempEndDate.setUTCMonth(tempEndDate.getUTCMonth() + 1);
                         }
                         cycleNaturalEndDate = addDays(tempEndDate, -1);
                    }
                    projectionEndDateForCalculation = cycleNaturalEndDate >= today ? cycleNaturalEndDate : new Date(today);
                }
            }
            
            const ledgerEntries = generateLedgerEntries(member.id, toInputDateString(projectionEndDateForCalculation));
            
            let totalOverdueSum = 0;
            let firstUnpaidPeriodStartDate = null; // To store the start date of the earliest unpaid period

            const sortedLedgerEntries = ledgerEntries.sort((a, b) => {
                const dateA = parseLocalDate(a.periodStartDate);
                const dateB = parseLocalDate(b.periodStartDate);
                if (!dateA || !dateB) return 0;
                return dateA - dateB;
            });

            for (const entry of sortedLedgerEntries) {
                const entryStartDateObj = parseLocalDate(entry.periodStartDate);
                const entryEndDateObj = parseLocalDate(entry.periodEndDate);

                if (!entryStartDateObj || !entryEndDateObj || entry.status === 'Inactive') continue;

                // Calculate balance for this specific period
                const paidForPeriod = entry.payments.filter(p => p.paymentType === 'Monthly Fee').reduce((sum, p) => sum + p.amount, 0) +
                                      entry.writeOffs.reduce((sum, w) => sum + w.amount, 0);
                const balanceForPeriod = entry.feesDue - paidForPeriod;

                if (balanceForPeriod > 0) {
                    totalOverdueSum += balanceForPeriod;

                    // If this period is unpaid and its start date is on or before today,
                    // and it's earlier than any previously found unpaid period start date, update it.
                    if (entryStartDateObj <= today) {
                        if (firstUnpaidPeriodStartDate === null || entryStartDateObj < firstUnpaidPeriodStartDate) {
                            firstUnpaidPeriodStartDate = entryStartDateObj;
                        }
                    }
                }
            }
            
            let calculatedDaysOverdue = 0;
            if (totalOverdueSum > 0 && firstUnpaidPeriodStartDate) {
                // Calculate days from the START of the first unpaid period that has begun
                // Time difference in milliseconds
                const timeDiff = today.getTime() - firstUnpaidPeriodStartDate.getTime();
                // Convert to days and add 1 (e.g., if due today, it's 1 day due)
                calculatedDaysOverdue = Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1;
            }

            return {
                overdueAmount: Math.max(0, totalOverdueSum),
                daysOverdue: Math.max(0, calculatedDaysOverdue) // Ensures daysOverdue is not negative
            };
        };


        // --- Memberships Logic ---
        const openMemberModal = (member = null) => {
            memberForm.reset();
            memberIdInput.value = '';
            originalAdmissionFeePaymentIdInput.value = '';
            memberNameError.classList.add('hidden');
            const todayStr = getTodayInputDate();
            memberJoinDateInput.readOnly = false;
            memberJoinDateInput.classList.remove('bg-gray-200', 'cursor-not-allowed');

            if (member) {
                modalTitle.textContent = 'Edit Member';
                memberIdInput.value = member.id;
                originalJoinDateInput.value = member.joinDate; 
                memberNameInput.value = member.name || '';
                memberGenderInput.value = member.gender || '';
                memberMobileInput.value = member.mobile || '';
                memberEmailInput.value = member.email || '';
                memberCnicInput.value = member.cnic || '';
                memberAdmissionFeeInput.value = member.admissionFee || ''; 
                memberJoinDateInput.value = member.joinDate;
		        memberJoinDateInput.readOnly = true;
                memberJoinDateInput.classList.add('bg-gray-200', 'cursor-default');
                memberJoinDateInput.title = "Join date cannot be changed after member creation.";
                memberPaymentCycleDayInput.value = getLatestValueFromHistory(member.paymentCycleDayHistory, new Date().getUTCDate());
                memberFeeInput.value = getLatestValueFromHistory(member.monthlyFeeHistory, 0);
                memberStatusInput.value = getLatestValueFromHistory(member.statusHistory, 'Active');
                logInitialMonthlyFeeContainer.classList.add('hidden');

                const existingAdmissionPayment = payments.find(p => p.memberId === member.id && p.paymentType === 'Admission Fee' && p.appliedToPeriodStartDate === member.joinDate);
                if (existingAdmissionPayment) {
                    originalAdmissionFeePaymentIdInput.value = existingAdmissionPayment.id;
                }

            } else {
                modalTitle.textContent = 'Add New Member';
                memberJoinDateInput.value = todayStr;
                memberPaymentCycleDayInput.value = new Date().getDate(); 
                memberStatusInput.value = 'Active';
                memberCnicInput.value = '';
                memberAdmissionFeeInput.value = '';
                logInitialMonthlyFeeContainer.classList.remove('hidden');
                logInitialMonthlyFeeCheckbox.checked = true;
		        memberJoinDateInput.title = ""; 
            }
            memberModal.classList.remove('hidden');
        };

        const closeMemberModal = () => memberModal.classList.add('hidden');
        
        memberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            memberNameError.classList.add('hidden');
            const todayStr = getTodayInputDate();

            const monthlyFeeValue = parseFloat(memberFeeInput.value);
            const newAdmissionFeeValue = parseFloat(memberAdmissionFeeInput.value) || 0;
            const cycleDay = parseInt(memberPaymentCycleDayInput.value);
            const currentId = memberIdInput.value;
            const nameValue = memberNameInput.value.trim();
            const newJoinDateValue = memberJoinDateInput.value;
            const oldJoinDateValue = originalJoinDateInput.value;

            if (isNaN(cycleDay) || cycleDay < 1 || cycleDay > 31) { alert("Please enter a valid payment day (1-31)."); memberPaymentCycleDayInput.focus(); return; }
            if (isNaN(monthlyFeeValue) || monthlyFeeValue < 0) { alert("Please enter a valid non-negative monthly fee."); memberFeeInput.focus(); return; }
            if (newAdmissionFeeValue < 0) { alert("Admission fee cannot be negative."); memberAdmissionFeeInput.focus(); return; }
            if (!newJoinDateValue || !parseLocalDate(newJoinDateValue)) { alert("Please enter a valid Join Date."); memberJoinDateInput.focus(); return; }

            const isDuplicateName = members.some(m => m.name.trim().toLowerCase() === nameValue.toLowerCase() && m.id !== currentId);
            if (isDuplicateName) { memberNameError.classList.remove('hidden'); memberNameInput.focus(); return; }

            let memberData;
            let isNewMember = false;

            if (currentId) { // Editing existing member
                const memberIndex = members.findIndex(m => m.id === currentId);
                if (memberIndex === -1) {
                    alert("Error: Member to edit not found locally.");
                    return;
                }
                memberData = { ...members[memberIndex] }; // Create a mutable copy

                memberData.name = nameValue;
                memberData.gender = memberGenderInput.value;
                memberData.mobile = memberMobileInput.value.trim();
                memberData.email = memberEmailInput.value.trim();
                memberData.cnic = memberCnicInput.value.trim();
                memberData.admissionFee = newAdmissionFeeValue;
                // memberData.joinDate is not changed here as it's read-only after creation in the modal

                // --- Payment Cycle Day History Change ---
                const latestExistingPaymentCycleDay = getLatestValueFromHistory(memberData.paymentCycleDayHistory, 1);
                if (cycleDay !== latestExistingPaymentCycleDay) {
                    const todayDateObj = parseLocalDate(todayStr);
                    let effectiveYear = todayDateObj.getUTCFullYear();
                    let effectiveMonth = todayDateObj.getUTCMonth();
                    if (todayDateObj.getUTCDate() > cycleDay) {
                        effectiveMonth += 1;
                        if (effectiveMonth > 11) { effectiveMonth = 0; effectiveYear += 1; }
                    }
                    const daysInEffectiveMonth = new Date(Date.UTC(effectiveYear, effectiveMonth + 1, 0)).getUTCDate();
                    const effectiveDay = Math.min(cycleDay, daysInEffectiveMonth);
                    let calculatedEffectiveDateObj = new Date(Date.UTC(effectiveYear, effectiveMonth, effectiveDay));
                    if (parseLocalDate(memberData.joinDate) && calculatedEffectiveDateObj < parseLocalDate(memberData.joinDate)) {
                        calculatedEffectiveDateObj = new Date(parseLocalDate(memberData.joinDate));
                    }
                    updateOrAddHistoryEntry(memberData, 'paymentCycleDayHistory', cycleDay, toInputDateString(calculatedEffectiveDateObj));
                }

                // --- Monthly Fee History Change ---
                const latestExistingMonthlyFee = getLatestValueFromHistory(memberData.monthlyFeeHistory, 0);
                if (monthlyFeeValue !== latestExistingMonthlyFee) {
                    const todayDateObj = parseLocalDate(todayStr);
                    const targetPaymentDayForFee = cycleDay;
                    let effectiveYear = todayDateObj.getUTCFullYear();
                    let effectiveMonth = todayDateObj.getUTCMonth();
                    if (todayDateObj.getUTCDate() > targetPaymentDayForFee) {
                        effectiveMonth += 1;
                        if (effectiveMonth > 11) { effectiveMonth = 0; effectiveYear += 1; }
                    }
                    const daysInEffectiveMonth = new Date(Date.UTC(effectiveYear, effectiveMonth + 1, 0)).getUTCDate();
                    const effectiveDay = Math.min(targetPaymentDayForFee, daysInEffectiveMonth);
                    let calculatedEffectiveDateObj = new Date(Date.UTC(effectiveYear, effectiveMonth, effectiveDay));
                     if (parseLocalDate(memberData.joinDate) && calculatedEffectiveDateObj < parseLocalDate(memberData.joinDate)) {
                        calculatedEffectiveDateObj = new Date(parseLocalDate(memberData.joinDate));
                    }
                    updateOrAddHistoryEntry(memberData, 'monthlyFeeHistory', monthlyFeeValue, toInputDateString(calculatedEffectiveDateObj));
                }

                // --- Status History Change ---
                const newStatusFromForm = memberStatusInput.value;
                const latestExistingStatus = getLatestValueFromHistory(memberData.statusHistory, 'Inactive');
                if (newStatusFromForm !== latestExistingStatus) {
                    updateOrAddHistoryEntry(memberData, 'statusHistory', newStatusFromForm, todayStr);
                }
            } else { // Adding new member
                isNewMember = true;
                memberData = {
                    id: generateId(),
                    name: nameValue,
                    gender: memberGenderInput.value,
                    mobile: memberMobileInput.value.trim(),
                    email: memberEmailInput.value.trim(),
                    cnic: memberCnicInput.value.trim(),
                    admissionFee: newAdmissionFeeValue,
                    joinDate: newJoinDateValue,
                    monthlyFeeHistory: [{ id: generateId(), value: monthlyFeeValue, effectiveDate: newJoinDateValue }],
                    statusHistory: [{ id: generateId(), value: memberStatusInput.value, effectiveDate: newJoinDateValue }],
                    paymentCycleDayHistory: [{ id: generateId(), value: cycleDay, effectiveDate: newJoinDateValue }],
                };
            }

            try {
                const savedMember = await apiCall(isNewMember ? '/members' : `/members/${currentId}`, isNewMember ? 'POST' : 'PUT', memberData);
                
                // Sync Admission Fee Payment if it changed or is new
                let admissionPaymentIdToSync = originalAdmissionFeePaymentIdInput.value;
                let admissionPayment = admissionPaymentIdToSync ? payments.find(p => p.id === admissionPaymentIdToSync) : null;
                if (!admissionPayment && oldJoinDateValue) { 
                    admissionPayment = payments.find(p => p.memberId === savedMember.id && p.paymentType === 'Admission Fee' && p.appliedToPeriodStartDate === oldJoinDateValue);
                } else if (!admissionPayment && !oldJoinDateValue && !isNewMember) {
                     admissionPayment = payments.find(p => p.memberId === savedMember.id && p.paymentType === 'Admission Fee' && p.appliedToPeriodStartDate === savedMember.joinDate);
                }

                if (newAdmissionFeeValue > 0) {
                    let paymentToSave;
                    if (admissionPayment) { // Existing admission payment needs update
                        paymentToSave = { ...admissionPayment, amount: newAdmissionFeeValue, date: savedMember.joinDate, appliedToPeriodStartDate: savedMember.joinDate };
                         await apiCall(`/payments/${admissionPayment.id}`, 'PUT', paymentToSave);
                    } else { // New admission payment
                        paymentToSave = {
                            id: generateId(), memberId: savedMember.id,
                            date: savedMember.joinDate, appliedToPeriodStartDate: savedMember.joinDate,
                            paymentType: 'Admission Fee', amount: newAdmissionFeeValue
                        };
                        await apiCall('/payments', 'POST', paymentToSave);
                    }
                     // Update local payments array
                    const paymentIndex = payments.findIndex(p => p.id === paymentToSave.id);
                    if (paymentIndex > -1) payments[paymentIndex] = paymentToSave; else payments.push(paymentToSave);

                } else { // Admission fee is 0 or not set, delete if existing
                    if (admissionPayment) {
                        await apiCall(`/payments/${admissionPayment.id}`, 'DELETE');
                        payments = payments.filter(p => p.id !== admissionPayment.id);
                    }
                }

                // Log initial monthly fee if new member and checkbox is checked
                if (isNewMember && monthlyFeeValue > 0 && logInitialMonthlyFeeCheckbox.checked) {
                    const initialMonthlyPayment = {
                        id: generateId(), memberId: savedMember.id,
                        date: savedMember.joinDate, appliedToPeriodStartDate: savedMember.joinDate,
                        paymentType: 'Monthly Fee', amount: monthlyFeeValue
                    };
                    await apiCall('/payments', 'POST', initialMonthlyPayment);
                    payments.push(initialMonthlyPayment);
                }

                // Update local members array
                if (isNewMember) {
                    members.push(savedMember);
                } else {
                    const memberIndex = members.findIndex(m => m.id === savedMember.id);
                    if (memberIndex > -1) members[memberIndex] = savedMember;
                }

                renderMembersTable();
                updateRevenueMetrics();
                renderSalesChart(currentChartYear);
                if (selectedLedgerMemberId === savedMember.id) {
                    renderMemberLedger(selectedLedgerMemberId, selectedLedgerViewYear);
                }
                renderHomeTabContent();
                closeMemberModal();

            } catch (error) {
                console.error("Failed to save member:", error);
                // Error already alerted by apiCall helper
            }
        });


        memberCnicInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length > 13) value = value.substring(0, 13);
            let formattedValue = '';
            if (value.length > 0) formattedValue += value.substring(0, Math.min(5, value.length));
            if (value.length > 5) formattedValue += '-' + value.substring(5, Math.min(12, value.length));
            if (value.length > 12) formattedValue += '-' + value.substring(12, 13);
            e.target.value = formattedValue;
        });
 
 	memberMobileInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

	const getMemberFeeStatusForTable = (memberId) => {
        const details = getMemberOverdueDetails(memberId);

        if (details.overdueAmount > 0) {
            if (details.daysOverdue > 0) { // Overdue from a past period
                return {
                    status: `Due (${details.daysOverdue} day${details.daysOverdue > 1 ? 's' : ''})`,
                    class: 'status-due',
                    sortValue: details.daysOverdue 
                };
            } else { // Due, but for the current or a future period (daysOverdue is 0)
                return {
                    status: 'Due',
                    class: 'status-due',
                    sortValue: 100000 
                };
            }
        } else { // Not overdue
            return {
                status: 'Paid',
                class: 'status-paid',
                sortValue: Infinity 
            };
        }
    };


    const renderMembersTable = (baseMembers = members) => {
        // currentPage is global, itemsPerPage is a const
        let filteredMembers = [...baseMembers];
        const todayStr = getTodayInputDate();

        const activeTagFilters = activeMemberFilters.filter(f => f !== 'all');
        if (activeTagFilters.length > 0) {
            const statusFilters = activeTagFilters.filter(f => ['active', 'inactive'].includes(f));
            const genderFilters = activeTagFilters.filter(f => ['Male', 'Female'].includes(f));
                const conditionFilters = activeTagFilters.filter(f => ['overdue'].includes(f)); // Removed 'new'

            filteredMembers = baseMembers.filter(member => {
                let matchesStatus = true;
                let matchesGender = true;
                let matchesConditions = true;
                
                const memberCurrentStatus = getEffectiveValue(member.statusHistory, todayStr, 'Inactive');

                if (statusFilters.length > 0) {
                     matchesStatus = statusFilters.some(filter => memberCurrentStatus.toLowerCase() === filter);
                }
                if (genderFilters.length > 0) {
                     matchesGender = genderFilters.some(filter => member.gender === filter);
                }

                if (statusFilters.length > 0 && genderFilters.length > 0) {
                    if (!matchesStatus || !matchesGender) return false;
                } else if (statusFilters.length > 0 && !matchesStatus) {
                    return false;
                } else if (genderFilters.length > 0 && !matchesGender) {
                    return false;
                }

                if (conditionFilters.length > 0) {
                    matchesConditions = conditionFilters.every(filter => {
                        if (filter === 'overdue') {
                            return getMemberOverdueDetails(member.id).overdueAmount > 0;
                        }
                        return true;
                    });
                }
                return matchesConditions;
            });
        }

        memberFilterCountEl.textContent = `Filtered Members = ${filteredMembers.length}`;

        const searchTerm = memberSearchInput.value.toLowerCase().trim();
        if (searchTerm) {
            filteredMembers = filteredMembers.filter(member =>
                (member.name || '').toLowerCase().includes(searchTerm) ||
                (member.mobile || '').toLowerCase().includes(searchTerm) ||
                (member.email || '').toLowerCase().includes(searchTerm)
            );
        }

        let membersWithFeeStatus;
        if (currentSort.column === 'fees') {
            membersWithFeeStatus = filteredMembers.map(member => ({
                ...member,
                feeStatusInfo: getMemberFeeStatusForTable(member.id)
            }));
        } else {
            membersWithFeeStatus = filteredMembers; 
        }


        const sortedMembers = [...membersWithFeeStatus].sort((a, b) => {
            let valA, valB;
            const col = currentSort.column;

            const aStatus = (col !== 'fees' && a.statusHistory) ? getEffectiveValue(a.statusHistory, todayStr, 'Inactive') : null;
            const bStatus = (col !== 'fees' && b.statusHistory) ? getEffectiveValue(b.statusHistory, todayStr, 'Inactive') : null;

            if (col === 'name' || col === 'mobile') {
                valA = (a[col] || '').toLowerCase();
                valB = (b[col] || '').toLowerCase();
            } else if (col === 'joinDate') {
                valA = parseLocalDate(a.joinDate) || new Date(0);
                valB = parseLocalDate(b.joinDate) || new Date(0);
            } else if (col === 'status') {
                valA = (aStatus || '').toLowerCase();
                valB = (bStatus || '').toLowerCase();
            } else if (col === 'fees') {
                valA = a.feeStatusInfo ? a.feeStatusInfo.sortValue : getMemberFeeStatusForTable(a.id).sortValue;
                valB = b.feeStatusInfo ? b.feeStatusInfo.sortValue : getMemberFeeStatusForTable(b.id).sortValue;
            } else {
                valA = a[col]; valB = b[col];
            }

            if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
            
            if (a.name && b.name) {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
            }
            return 0;
        });

        // Pagination Logic
        const totalFilteredMembers = sortedMembers.length;
        const totalPages = Math.ceil(totalFilteredMembers / itemsPerPage);
        if (currentPage > totalPages && totalPages > 0) currentPage = totalPages; // Adjust if current page is out of bounds
        if (currentPage < 1 && totalPages > 0) currentPage = 1; // Ensure currentPage is at least 1

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedMembers = sortedMembers.slice(startIndex, endIndex);

        membersTableBody.innerHTML = '';
        if (paginatedMembers.length === 0) {
            membersTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No members found.</td></tr>`;
            renderPaginationControls(totalFilteredMembers, totalPages); // Still render controls to show "0 members"
            return;
        }

        paginatedMembers.forEach(member => {
            const feeStatusInfo = member.feeStatusInfo || getMemberFeeStatusForTable(member.id);
            const memberCurrentStatus = getEffectiveValue(member.statusHistory, todayStr, 'Inactive');
            const memberStatusClass = memberCurrentStatus === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

            const row = `
                <tr id="member-row-${member.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <a href="#"
                           onclick="navigateToLedgerForMember('${member.id}'); return false;"
                           class="text-indigo-600 hover:text-indigo-800 hover:underline cursor-pointer"
                           title="View Ledger for ${member.name || 'this member'}">
                            ${member.name || 'N/A'}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${member.mobile || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${formatDate(member.joinDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${feeStatusInfo.class}">
                            ${feeStatusInfo.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${memberStatusClass}">
                            ${memberCurrentStatus}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium table-actions justify-center">
                        <button onclick="editMember('${member.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDeleteMember('${member.id}', '${member.name || 'this member'}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>`;
            membersTableBody.innerHTML += row;
        });
        
        membersThead.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (th.dataset.sort === currentSort.column) {
                th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });
        renderPaginationControls(totalFilteredMembers, totalPages);
    };

        const renderRecentPaymentsList = () => {
            if (!recentPaymentsListEl) return;
            recentPaymentsListEl.innerHTML = '<li class="text-gray-500 py-2">Loading recent payments...</li>';

            if (!payments || payments.length === 0) {
                recentPaymentsListEl.innerHTML = '<li class="text-gray-500 py-2">No payments found.</li>';
                return;
            }

            const todayUTC = parseLocalDate(getTodayInputDate());
            if (!todayUTC) {
                recentPaymentsListEl.innerHTML = '<li class="text-red-500 py-2">Error determining current date.</li>';
                return;
            }

            const recentPayments = payments
                .filter(payment => {
                    if (currentHomePaymentsGenderFilter === 'all') return true;
                    const member = members.find(m => m.id === payment.memberId); // Ensure members array is accessible
                    return member && member.gender === currentHomePaymentsGenderFilter;
                })
                .map(payment => {
                    const paymentDateObj = parseLocalDate(payment.date);
                    return { ...payment, paymentDateObj };
                })
                .filter(payment => 
                    payment.paymentDateObj && payment.paymentDateObj.getTime() === todayUTC.getTime()
                )
                .sort((a, b) => b.paymentDateObj - a.paymentDateObj); // Most recent first

            if (recentPayments.length === 0) {
                recentPaymentsListEl.innerHTML = '<li class="text-gray-500 py-2">No payments recorded today.</li>';
                return;
            }

            recentPaymentsListEl.innerHTML = ''; // Clear loading/previous
            recentPayments.forEach(payment => {
                const member = members.find(m => m.id === payment.memberId);
                const memberName = member ? member.name : 'Unknown Member';
                // const paymentTypeDisplay = payment.paymentType || 'Payment'; // Not used in current display
                
                const listItem = document.createElement('li');
                listItem.className = 'text-sm text-gray-700 border-b border-gray-200 pb-2 mb-2'; // Added pb-2 for consistency
                listItem.innerHTML = `
                    <span class="text-green-700 font-medium">Rs ${formatCurrency(payment.amount)}</span> 
                    paid by 
                    <a href="#" onclick="navigateToLedgerForMember('${payment.memberId}'); return false;" 
                       class="text-indigo-600 hover:text-indigo-800 font-medium cursor-pointer"
                       title="View Ledger for ${memberName}">
                        ${memberName}
                    </a> on 
                    <span class="text-red-700 font-normal">${formatDate(payment.paymentDateObj)}</span>.
                `;
                recentPaymentsListEl.appendChild(listItem);
            });
        };

       const renderRecentJoinsList = () => {
            if (!recentJoinsListEl) return;
            recentJoinsListEl.innerHTML = '<li class="text-gray-500 py-2">Loading recent joins...</li>';

            if (!members || members.length === 0) {
                recentJoinsListEl.innerHTML = '<li class="text-gray-500 py-2">No members found.</li>';
                return;
            }
            
            const todayUTC = parseLocalDate(getTodayInputDate());
             if (!todayUTC) {
                recentJoinsListEl.innerHTML = '<li class="text-red-500 py-2">Error determining current date.</li>';
                return;
            }
            const firstDayOfCurrentMonthUTC = new Date(Date.UTC(todayUTC.getUTCFullYear(), todayUTC.getUTCMonth(), 1));

            const recentJoins = members
                .filter(member => {
                    if (currentHomeJoinsGenderFilter === 'all') return true;
                    return member.gender === currentHomeJoinsGenderFilter;
                })
                .map(member => {
                    const joinDateObj = parseLocalDate(member.joinDate);
                    return { ...member, joinDateObj };
                })
                .filter(member => member.joinDateObj && member.joinDateObj >= firstDayOfCurrentMonthUTC && member.joinDateObj <= todayUTC)
                .sort((a, b) => b.joinDateObj - a.joinDateObj); // Most recent first

            if (recentJoins.length === 0) {
                recentJoinsListEl.innerHTML = '<li class="text-gray-500 py-2">No new members joined this month.</li>';
                return;
            }

            recentJoinsListEl.innerHTML = ''; // Clear loading/previous
            recentJoins.forEach(member => {
                const listItem = document.createElement('li');
                listItem.className = 'text-sm text-gray-700 border-b border-gray-200 pb-2 mb-2'; // Added pb-2 for consistency
                listItem.innerHTML = `
                    <a href="#" onclick="navigateToLedgerForMember('${member.id}'); return false;"
                       class="text-indigo-600 hover:text-indigo-800 font-medium cursor-pointer"
                       title="View Ledger for ${member.name}">
                        ${member.name}
                    </a> joined on 
                    <span class="text-red-700">${formatDate(member.joinDateObj)}</span>.
                `;
                recentJoinsListEl.appendChild(listItem);
            });
        };

        const renderHomeTabContent = () => {
            renderRecentPaymentsList();
            renderRecentJoinsList();
        };

        // Event Listeners for Home Tab Gender Filters
        if (homePaymentsGenderFilterControls) {
            homePaymentsGenderFilterControls.addEventListener('click', (e) => {
                const button = e.target.closest('.gender-filter-btn');
                if (!button) return;
                currentHomePaymentsGenderFilter = button.dataset.gender;
                homePaymentsGenderFilterControls.querySelectorAll('.gender-filter-btn').forEach(btn => btn.classList.remove('gender-filter-active'));
                button.classList.add('gender-filter-active');
                renderRecentPaymentsList();
            });
        }

        if (homeJoinsGenderFilterControls) {
            homeJoinsGenderFilterControls.addEventListener('click', (e) => {
                const button = e.target.closest('.gender-filter-btn');
                if (!button) return;
                currentHomeJoinsGenderFilter = button.dataset.gender;
                homeJoinsGenderFilterControls.querySelectorAll('.gender-filter-btn').forEach(btn => btn.classList.remove('gender-filter-active'));
                button.classList.add('gender-filter-active');
                renderRecentJoinsList();
            });
        }

        window.navigateToLedgerForMember = (memberId) => {
        };


        window.navigateToLedgerForMember = (memberId) => {
            const member = members.find(m => m.id === memberId);
            if (!member) {
                console.error("Member not found for ledger navigation:", memberId);
                alert("Error: Could not find the member to navigate to their ledger.");
                return;
            }

            selectedLedgerMemberId = memberId;
            // You might want to set a specific year, e.g., current year or member's join year
            selectedLedgerViewYear = new Date().getFullYear(); 

            const ledgerTabLink = document.querySelector('.tab-link[data-tab="ledger"]');
            if (ledgerTabLink) {
                ledgerTabLink.click(); // This will trigger the existing tab switching logic
                                       // which will then use selectedLedgerMemberId
            } else {
                console.error("Ledger tab link not found. Cannot navigate.");
                alert("Error: Could not navigate to the ledger tab.");
            }
        };

    const renderPaginationControls = (totalItems, totalPages) => {
        membersPaginationControlsEl.innerHTML = ''; // Clear previous controls

        if (totalItems === 0 && activeMemberFilters.includes('all') && !memberSearchInput.value) {
             membersPaginationControlsEl.innerHTML = `<span class="text-sm text-gray-700">No members in the system yet.</span>`;
             return;
        }
        if (totalPages <= 1 && totalItems <= itemsPerPage) { // No need for pagination if all items fit on one page or no items
            if (totalItems > 0) {
                 membersPaginationControlsEl.innerHTML = `<span class="text-sm text-gray-700">Showing ${totalItems} of ${totalItems} members</span>`;
            } else if (memberSearchInput.value || !activeMemberFilters.includes('all')) {
                 membersPaginationControlsEl.innerHTML = `<span class="text-sm text-gray-700">No members match your current filter/search.</span>`;
            }
            return;
        }

        const startItem = Math.min((currentPage - 1) * itemsPerPage + 1, totalItems);
        const endItem = Math.min(currentPage * itemsPerPage, totalItems);

        let html = `<span class="text-sm text-gray-700">Showing ${startItem}-${endItem} of ${totalItems} members</span>`;
        html += `<div class="space-x-2">`;

        if (currentPage > 1) {
            html += `<button onclick="changePage(${currentPage - 1})" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-100">Previous</button>`;
        } else {
            html += `<button class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-400 cursor-not-allowed" disabled>Previous</button>`;
        }

        if (currentPage < totalPages) {
            html += `<button onclick="changePage(${currentPage + 1})" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-100">Next</button>`;
        } else {
            html += `<button class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-400 cursor-not-allowed" disabled>Next</button>`;
        }
        html += `</div>`;
        membersPaginationControlsEl.innerHTML = html;
    };

    memberFilterTagsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-tag')) {
            const clickedFilter = e.target.dataset.filter;

            if (clickedFilter === 'all') {
                activeMemberFilters = ['all'];
            } else {
                if (activeMemberFilters.includes('all')) {
                    activeMemberFilters = activeMemberFilters.filter(f => f !== 'all');
                }

                const currentIdx = activeMemberFilters.indexOf(clickedFilter);

                if (currentIdx > -1) {
                    activeMemberFilters.splice(currentIdx, 1);
                } else {
                    const statusFilters = ['active', 'inactive'];
                    const genderFilters = ['Male', 'Female'];

                    if (statusFilters.includes(clickedFilter)) {
                        activeMemberFilters = activeMemberFilters.filter(f => !statusFilters.includes(f));
                    } else if (genderFilters.includes(clickedFilter)) {
                        activeMemberFilters = activeMemberFilters.filter(f => !genderFilters.includes(f));
                    }
                    activeMemberFilters.push(clickedFilter);
                }
            }

            if (activeMemberFilters.length === 0) {
                activeMemberFilters = ['all'];
            }

            memberFilterTagsContainer.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.toggle('filter-tag-active', activeMemberFilters.includes(tag.dataset.filter));
            });
            currentPage = 1; // Reset to first page on filter change
            renderMembersTable();
        }
    });

    membersThead.addEventListener('click', (e) => {
        const header = e.target.closest('th.sortable');
        if (!header) return;
        const sortColumn = header.dataset.sort;
        if (currentSort.column === sortColumn) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = sortColumn;
            currentSort.direction = 'asc';
        }
        currentPage = 1; // Reset to first page on sort change
        renderMembersTable();
    });

    window.editMember = (id) => {
        const member = members.find(m => m.id === id);
        if (member) openMemberModal(member);
    };

    window.confirmDeleteMember = (id, name) => {
        confirmationTitle.textContent = 'Delete Member';
        confirmationMessage.textContent = `Delete "${name}"? All associated payments, write-offs, and ledger history for this member will also be PERMANENTLY DELETED. This action cannot be undone.`;
        confirmActionBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md';
        currentActionCallback = () => deleteMember(id);
        confirmationModal.classList.remove('hidden');
    };

    const deleteMember = async (id) => {
        try {
            await apiCall(`/members/${id}`, 'DELETE');
            members = members.filter(m => m.id !== id);
            payments = payments.filter(p => p.memberId !== id); // Also remove associated payments locally
            writeOffs = writeOffs.filter(w => w.memberId !== id); // And write-offs

            renderMembersTable();
            updateRevenueMetrics();
            renderSalesChart(currentChartYear);
            if (selectedLedgerMemberId === id) {
                resetLedgerSelectionAndDisplay();
            }
            renderHomeTabContent();
            closeConfirmationModal();
        } catch (error) {
            console.error("Failed to delete member:", error);
        }
    };

    memberSearchInput.addEventListener('input', () => {
        currentPage = 1; // Reset to first page on search
        renderMembersTable();
    });

    window.changePage = (newPage) => {
        currentPage = newPage;
        renderMembersTable();
    };

    // --- Suggestion Box Logic ---
    const getMemberSuggestions = (inputValue, memberSourceArray) => {
        const trimmedInput = inputValue.trim().toLowerCase();
        if (!trimmedInput) return [];
        return memberSourceArray.filter(member =>
            (member.name || '').toLowerCase().includes(trimmedInput) ||
            (member.mobile || '').includes(trimmedInput)
        ).slice(0, 5); 
    };

    const displaySuggestions = (inputElement, suggestionsContainer, suggestions) => {
        suggestionsContainer.innerHTML = '';
        if (suggestions.length === 0) {
            suggestionsContainer.classList.add('hidden'); return;
        }
        suggestions.forEach(member => {
            const item = document.createElement('div');
            item.classList.add('suggestion-item');
            item.textContent = member.name;
            if (member.mobile) {
                const mobileSpan = document.createElement('small');
                mobileSpan.textContent = `(${member.mobile})`;
                item.appendChild(mobileSpan);
            }
            item.addEventListener('click', () => {
                inputElement.value = member.name;
                inputElement.dataset.selectedMemberId = member.id; 
                inputElement.classList.add('input-success');
                hideSuggestions(suggestionsContainer);
                if (inputElement.id === 'ledger-member-input') {
                    selectedLedgerMemberId = member.id; 
                    selectedLedgerViewYear = new Date().getFullYear(); 
                    renderMemberLedger(member.id, selectedLedgerViewYear); 
                    updateLedgerControlsVisibility(); 
                }
            });
            suggestionsContainer.appendChild(item);
        });
        suggestionsContainer.classList.remove('hidden');
    };

    const hideSuggestions = (suggestionsContainer) => {
        if (suggestionsContainer) suggestionsContainer.classList.add('hidden');
    };

    ledgerMemberInput.addEventListener('input', () => {
        const inputValue = ledgerMemberInput.value;
        const wasSelected = ledgerMemberInput.dataset.selectedMemberId; 

        ledgerMemberInput.classList.remove('input-success'); 
        ledgerMemberInput.removeAttribute('data-selected-member-id'); 

        if (selectedLedgerMemberId && wasSelected) {
            selectedLedgerMemberId = null; 
            renderMemberLedger(null);      
            updateLedgerControlsVisibility(); 
        }

        if (inputValue.length < 1) { 
            hideSuggestions(ledgerMemberSuggestionsEl);
            if (!selectedLedgerMemberId) updateLedgerControlsVisibility();
            return;
        }
        const suggestions = getMemberSuggestions(inputValue, members); 
        displaySuggestions(ledgerMemberInput, ledgerMemberSuggestionsEl, suggestions);
    });
    document.addEventListener('click', (e) => { 
        if (ledgerMemberInput && ledgerMemberSuggestionsEl && !ledgerMemberInput.contains(e.target) && !ledgerMemberSuggestionsEl.contains(e.target)) {
            hideSuggestions(ledgerMemberSuggestionsEl);
        }
    });


    // --- Member Ledger Logic ---
    const generateLedgerEntries = (memberId, projectionEndDateStr) => {
            const member = members.find(m => m.id === memberId);
            if (!member) return [];

            const ledgerEntries = [];
            const eventDates = new Set();
            const projectionEndDateObj = parseLocalDate(projectionEndDateStr);
            if (!projectionEndDateObj) {
                console.error("Invalid projectionEndDateStr for ledger generation:", projectionEndDateStr);
                return [];
            }
            const joinDate = parseLocalDate(member.joinDate);
            if (!joinDate) {
                console.error("Invalid joinDate for member:", memberId);
                return [];
            }

            eventDates.add(member.joinDate);
            (member.statusHistory || []).forEach(h => eventDates.add(h.effectiveDate));
            (member.monthlyFeeHistory || []).forEach(h => eventDates.add(h.effectiveDate));
            (member.paymentCycleDayHistory || []).forEach(h => eventDates.add(h.effectiveDate));

            eventDates.add(toInputDateString(addDays(projectionEndDateObj, 1)));

            const sortedEventDates = Array.from(eventDates)
                .map(dStr => parseLocalDate(dStr))
                .filter(d => d && d >= joinDate) 
                .sort((a, b) => a - b)
                .filter((date, index, self) => index === self.findIndex(d => d.getTime() === date.getTime())); 


            for (let i = 0; i < sortedEventDates.length - 1; i++) {
                let segmentStartDate = sortedEventDates[i];
                let segmentEndDate = addDays(sortedEventDates[i + 1], -1);

                if (segmentStartDate > projectionEndDateObj) break; 
                if (segmentEndDate > projectionEndDateObj) segmentEndDate = new Date(projectionEndDateObj); 
                if (segmentStartDate > segmentEndDate) continue; 

                const status = getEffectiveValue(member.statusHistory, segmentStartDate, 'Inactive');
                const monthlyFee = parseFloat(getEffectiveValue(member.monthlyFeeHistory, segmentStartDate, 0));
                const paymentCycleDay = parseInt(getEffectiveValue(member.paymentCycleDayHistory, segmentStartDate, 1));

                const memberPayments = payments.filter(p => p.memberId === memberId);
                const memberWriteOffs = writeOffs.filter(w => w.memberId === memberId);


                if (status === 'Inactive') {
                    const periodPayments = memberPayments.filter(p => {
                        const paymentApplicationDateObj = parseLocalDate(p.appliedToPeriodStartDate);
                        return paymentApplicationDateObj &&
                               paymentApplicationDateObj >= segmentStartDate &&
                               paymentApplicationDateObj <= segmentEndDate;
                    });
                    const periodWriteOffs = memberWriteOffs.filter(w => {
                        const woStartDate = parseLocalDate(w.periodStartDate);
                        return woStartDate &&
                               woStartDate >= segmentStartDate &&
                               woStartDate <= segmentEndDate;
                    });
                    ledgerEntries.push({
                        periodStartDate: toInputDateString(segmentStartDate),
                        periodEndDate: toInputDateString(segmentEndDate),
                        feesDue: 0, 
                        payments: periodPayments,
                        writeOffs: periodWriteOffs,
                        status: 'Inactive'
                    });
                } else { // Active status
                    let currentPeriodStart = new Date(segmentStartDate);
                    const joinDateObj = parseLocalDate(member.joinDate);

                    let firstCycleDateOnOrAfterSegmentStart = new Date(Date.UTC(segmentStartDate.getUTCFullYear(), segmentStartDate.getUTCMonth(), paymentCycleDay));
                     if (firstCycleDateOnOrAfterSegmentStart < segmentStartDate ) { // If cycle day has passed this month
                         firstCycleDateOnOrAfterSegmentStart.setUTCMonth(firstCycleDateOnOrAfterSegmentStart.getUTCMonth() + 1);
                     }
                     // Align with join date if it's later than the calculated cycle start
                     if (joinDateObj && firstCycleDateOnOrAfterSegmentStart < joinDateObj) {
                         // This means the very first "cycle" will be from join date
                     }


                    // Handle initial partial period if segment starts before the first full cycle day within the segment
                    if (segmentStartDate < firstCycleDateOnOrAfterSegmentStart && segmentStartDate <= segmentEndDate) {
                        let initialPeriodEnd = addDays(firstCycleDateOnOrAfterSegmentStart, -1);
                        if (initialPeriodEnd > segmentEndDate) initialPeriodEnd = new Date(segmentEndDate);
                        if (initialPeriodEnd < segmentStartDate) initialPeriodEnd = new Date(segmentStartDate);


                        if (segmentStartDate <= initialPeriodEnd) {
                            const daysInPeriod = daysBetween(segmentStartDate, initialPeriodEnd);
                            let feesForPeriod = (monthlyFee / 30) * daysInPeriod; // Pro-rata
                            if (feesForPeriod > monthlyFee) feesForPeriod = monthlyFee;
                            feesForPeriod = Math.round(feesForPeriod);

                            const periodPayments = memberPayments.filter(payment => {
                                const paymentAppliedDateObj = parseLocalDate(payment.appliedToPeriodStartDate);
                                return paymentAppliedDateObj && paymentAppliedDateObj >= segmentStartDate && paymentAppliedDateObj <= initialPeriodEnd;
                            });
                            const periodWriteOffs = memberWriteOffs.filter(w =>
                                parseLocalDate(w.periodStartDate) >= segmentStartDate && parseLocalDate(w.periodStartDate) <= initialPeriodEnd &&
                                parseLocalDate(w.periodEndDate) >= segmentStartDate && parseLocalDate(w.periodEndDate) <= initialPeriodEnd
                            );


                            ledgerEntries.push({
                                periodStartDate: toInputDateString(segmentStartDate),
                                periodEndDate: toInputDateString(initialPeriodEnd),
                                feesDue: feesForPeriod,
                                payments: periodPayments,
                                writeOffs: periodWriteOffs,
                                status: 'Active'
                            });
                            currentPeriodStart = addDays(initialPeriodEnd, 1);
                        } else {
                             currentPeriodStart = new Date(segmentStartDate); // Fallback if dates are weird
                        }
                    } else {
                        currentPeriodStart = new Date(segmentStartDate);
                    }


                    while(currentPeriodStart <= segmentEndDate) {
                        let pStart = new Date(Date.UTC(currentPeriodStart.getUTCFullYear(), currentPeriodStart.getUTCMonth(), paymentCycleDay));
                        
                        if (currentPeriodStart > pStart) { // If currentPeriodStart is after this month's cycle day
                             pStart.setUTCMonth(pStart.getUTCMonth() + 1);
                        }
                        // Ensure pStart is not before currentPeriodStart (can happen if segment starts mid-cycle)
                        if (pStart < currentPeriodStart) pStart = new Date(currentPeriodStart);


                        let pEnd = addDays(new Date(Date.UTC(pStart.getUTCFullYear(), pStart.getUTCMonth() + 1, paymentCycleDay)), -1);
                        
                        // Clamp to segment boundaries
                        if (pStart < segmentStartDate) pStart = new Date(segmentStartDate);
                        if (pEnd > segmentEndDate) pEnd = new Date(segmentEndDate);

                        if (pStart > pEnd || pStart > segmentEndDate) break;
                        
                        let feesForPeriod;
                        const fullCycleStartCandidate = new Date(Date.UTC(pStart.getUTCFullYear(), pStart.getUTCMonth(), paymentCycleDay));
                        const fullCycleEndCandidate = addDays(new Date(Date.UTC(fullCycleStartCandidate.getUTCFullYear(), fullCycleStartCandidate.getUTCMonth() + 1, paymentCycleDay)), -1);
                        
                        if (pStart.getTime() === fullCycleStartCandidate.getTime() && pEnd.getTime() === fullCycleEndCandidate.getTime() && pStart >= joinDateObj) {
                            feesForPeriod = monthlyFee;
                        } else {
                            const daysInPeriod = daysBetween(pStart, pEnd);
                            feesForPeriod = (monthlyFee / 30) * daysInPeriod;
                             if (feesForPeriod > monthlyFee) feesForPeriod = monthlyFee;
                            feesForPeriod = Math.round(feesForPeriod);
                        }
                        
                        const periodPayments = memberPayments.filter(payment => {
                            const paymentAppliedDateObj = parseLocalDate(payment.appliedToPeriodStartDate);
                            return paymentAppliedDateObj && paymentAppliedDateObj >= pStart && paymentAppliedDateObj <= pEnd;
                        });
                        const periodWriteOffs = memberWriteOffs.filter(w =>
                            parseLocalDate(w.periodStartDate) >= pStart && parseLocalDate(w.periodStartDate) <= pEnd &&
                            parseLocalDate(w.periodEndDate) >= pStart && parseLocalDate(w.periodEndDate) <= pEnd
                        );

                        ledgerEntries.push({
                            periodStartDate: toInputDateString(pStart),
                            periodEndDate: toInputDateString(pEnd),
                            feesDue: feesForPeriod,
                            payments: periodPayments,
                            writeOffs: periodWriteOffs,
                            status: 'Active'
                        });
                        currentPeriodStart = addDays(pEnd, 1);
                    }
                }
            }
            
            const memberStatusAtProjectionEnd = getEffectiveValue(member.statusHistory, projectionEndDateObj, 'Inactive');
            if (memberStatusAtProjectionEnd === 'Active') {
                const currentFeeAtProjectionEnd = parseFloat(getEffectiveValue(member.monthlyFeeHistory, projectionEndDateObj, 0));
                const currentCycleDayAtProjectionEnd = parseInt(getEffectiveValue(member.paymentCycleDayHistory, projectionEndDateObj, 1));
                
                let cycleStartRelativeToProjectionEnd = new Date(Date.UTC(projectionEndDateObj.getUTCFullYear(), projectionEndDateObj.getUTCMonth(), currentCycleDayAtProjectionEnd));
                if (projectionEndDateObj.getUTCDate() < currentCycleDayAtProjectionEnd) {
                    cycleStartRelativeToProjectionEnd.setUTCMonth(cycleStartRelativeToProjectionEnd.getUTCMonth() - 1);
                }
                 if (joinDate && cycleStartRelativeToProjectionEnd < joinDate) {
                    cycleStartRelativeToProjectionEnd = new Date(joinDate);
                }
                
                const cycleEndRelativeToProjectionEnd = addDays(new Date(Date.UTC(cycleStartRelativeToProjectionEnd.getUTCFullYear(), cycleStartRelativeToProjectionEnd.getUTCMonth() + 1, currentCycleDayAtProjectionEnd)), -1);

                const cycleStartStr = toInputDateString(cycleStartRelativeToProjectionEnd);
                const cycleEndStr = toInputDateString(cycleEndRelativeToProjectionEnd);

                const lastLedgerEntry = ledgerEntries.length > 0 ? ledgerEntries[ledgerEntries.length - 1] : null;

                // Check if the last entry covers a part of the current full cycle but doesn't complete it
                 if (lastLedgerEntry &&
                    parseLocalDate(lastLedgerEntry.periodStartDate) <= cycleStartRelativeToProjectionEnd && // Last entry starts on or before this cycle
                    parseLocalDate(lastLedgerEntry.periodEndDate) < cycleEndRelativeToProjectionEnd &&    // But ends before this cycle truly ends
                    lastLedgerEntry.status === 'Active' &&
                    cycleStartRelativeToProjectionEnd <= projectionEndDateObj) // And this cycle should be considered within projection
                {
                    // This logic attempts to extend the last period to a full cycle if it was cut short by projection end.
                    // Check if the last entry's start date matches the current cycle's start date
                    if (lastLedgerEntry.periodStartDate === cycleStartStr) {
                        lastLedgerEntry.periodEndDate = cycleEndStr;
                        lastLedgerEntry.feesDue = currentFeeAtProjectionEnd; // Assume full fee for full cycle
                        // Re-filter payments/writeoffs for this potentially extended period
                        lastLedgerEntry.payments = payments.filter(p => p.memberId === memberId && p.appliedToPeriodStartDate === cycleStartStr);
                        lastLedgerEntry.writeOffs = writeOffs.filter(w => w.memberId === memberId && w.periodStartDate === cycleStartStr && w.periodEndDate === cycleEndStr);
                    }
                } else if ((!lastLedgerEntry || parseLocalDate(lastLedgerEntry.periodEndDate) < cycleStartRelativeToProjectionEnd) && 
                            cycleStartRelativeToProjectionEnd <= projectionEndDateObj) {
                    // If no last entry, or last entry ended before this cycle, add this full cycle if it's within projection.
                    const isAlreadyCovered = ledgerEntries.some(e => e.periodStartDate === cycleStartStr && e.periodEndDate === cycleEndStr);
                    if (!isAlreadyCovered) {
                        ledgerEntries.push({
                            periodStartDate: cycleStartStr,
                            periodEndDate: cycleEndStr,
                            feesDue: currentFeeAtProjectionEnd,
                            payments: payments.filter(p => p.memberId === memberId && p.appliedToPeriodStartDate === cycleStartStr),
                            writeOffs: writeOffs.filter(w => w.memberId === memberId && w.periodStartDate === cycleStartStr && w.periodEndDate === cycleEndStr),
                            status: 'Active'
                        });
                    }
                }
            }
            
            ledgerEntries.sort((a, b) => {
                const dateA = parseLocalDate(a.periodStartDate);
                const dateB = parseLocalDate(b.periodStartDate);
                 if (!dateA || !dateB) return 0;
                return dateA - dateB;
            });
            // Deduplicate entries if any identical periods were generated
            const uniqueLedgerEntries = [];
            const seenPeriods = new Set();
            for (const entry of ledgerEntries) {
                const periodKey = `${entry.periodStartDate}-${entry.periodEndDate}`;
                if (!seenPeriods.has(periodKey)) {
                    uniqueLedgerEntries.push(entry);
                    seenPeriods.add(periodKey);
                }
            }

            return uniqueLedgerEntries;
        };

         const renderMemberLedger = (memberId, viewYear = new Date().getFullYear()) => {

            memberLedgerBody.innerHTML = '';
            ledgerTotalPaidEl.textContent = `${formatCurrency(0)} Rs`;
            ledgerTotalBalanceEl.textContent = `${formatCurrency(0)} Rs`;
            ledgerMemberOverdueAmountEl.textContent = `${formatCurrency(0)} Rs`; 

            if (!memberId) {
                ledgerDetailsContainer.classList.add('hidden');
                ledgerPlaceholder.classList.remove('hidden');
                return;
            }
            ledgerDetailsContainer.classList.remove('hidden');
            ledgerPlaceholder.classList.add('hidden');
            viewMemberHistoryBtn.classList.remove('hidden');
            ledgerControlsHeaderEl.classList.remove('hidden'); 

            currentLedgerYearDisplayEl.textContent = viewYear;
            const currentOverdueForMember = getMemberOverdueAmount(memberId);
            ledgerMemberOverdueAmountEl.textContent = `${formatCurrency(currentOverdueForMember)} Rs`;
            ledgerMemberOverdueAmountEl.className = `text-base font-bold ${currentOverdueForMember > 0 ? 'text-red-600' : 'text-green-600'}`;


            const projectionEndDateStr = `${viewYear}-12-31`;

            const allGeneratedEntries = generateLedgerEntries(memberId, projectionEndDateStr);

            const entriesForViewYear = allGeneratedEntries.filter(entry => {
                const entryStartDate = parseLocalDate(entry.periodStartDate);
                return entryStartDate && entryStartDate.getUTCFullYear() === viewYear;
            });

            if (entriesForViewYear.length === 0) {
                memberLedgerBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No ledger entries found for ${viewYear}.</td></tr>`;
                ledgerTotalPaidEl.textContent = `${formatCurrency(0)} Rs`;
                ledgerTotalBalanceEl.textContent = `${formatCurrency(0)} Rs`;
                ledgerTotalBalanceEl.className = `px-6 py-3 text-right text-sm font-semibold text-gray-700`;
                return;
            }

            let grandTotalMembershipFeesDue = 0;
            let grandTotalAllPaymentsAndWriteOffs = 0;
            let grandTotalMonthlyFeePaymentsAndWriteOffsForBalance = 0;
            
            const today = parseLocalDate(getTodayInputDate()); 

            entriesForViewYear.forEach(entry => {
                const membershipFeeDueForPeriod = entry.feesDue;

                const admissionFeePayments = entry.payments
                    .filter(p => p.paymentType === 'Admission Fee')
                    .sort((a, b) => (parseLocalDate(a.date) || 0) - (parseLocalDate(b.date) || 0));

                const monthlyFeePayments = entry.payments
                    .filter(p => p.paymentType === 'Monthly Fee')
                    .sort((a, b) => (parseLocalDate(a.date) || 0) - (parseLocalDate(b.date) || 0));
                
                const sortedWriteOffs = [...entry.writeOffs].sort((a, b) => (parseLocalDate(a.date) || 0) - (parseLocalDate(b.date) || 0));


                const admissionFeePaymentsHtml = admissionFeePayments.map(p => {
                    return `<span class="ledger-payment-item ledger-payment-item-admission" onclick="openPaymentEditModal('${p.id}')">${formatCurrency(p.amount)} Rs (${p.paymentType})</span>`;
                }).join('<br>');

                const monthlyFeePaymentsHtml = monthlyFeePayments.map(p => {
                    return `<span class="ledger-payment-item ledger-payment-item-monthly" onclick="openPaymentEditModal('${p.id}')">${formatCurrency(p.amount)} Rs (${p.paymentType})</span>`;
                }).join('<br>');

                const writeOffsForPeriodHtml = sortedWriteOffs.map(w =>
                    `<span class="ledger-writeoff-item" onclick="openWriteOffModal('${memberId}', '${entry.periodStartDate}', '${entry.periodEndDate}', '${w.id}')">${formatCurrency(w.amount)} Rs (Written-Off)</span>`
                ).join('<br>');

                const combinedPaidHtmlParts = [];
                if (admissionFeePaymentsHtml) combinedPaidHtmlParts.push(admissionFeePaymentsHtml);
                if (monthlyFeePaymentsHtml) combinedPaidHtmlParts.push(monthlyFeePaymentsHtml);
                if (writeOffsForPeriodHtml) combinedPaidHtmlParts.push(writeOffsForPeriodHtml);
                
                const combinedPaidHtml = combinedPaidHtmlParts.filter(Boolean).join('<br>');


                const monthlyFeePaymentsThisPeriod = entry.payments
                    .filter(p => p.paymentType === 'Monthly Fee')
                    .reduce((sum, p) => sum + p.amount, 0);
                const writeOffsThisPeriod = entry.writeOffs.reduce((sum, w) => sum + w.amount, 0);
                const balanceForPeriod = membershipFeeDueForPeriod - monthlyFeePaymentsThisPeriod - writeOffsThisPeriod;

                grandTotalMembershipFeesDue += membershipFeeDueForPeriod;
                entry.payments.forEach(p => grandTotalAllPaymentsAndWriteOffs += p.amount);
                grandTotalAllPaymentsAndWriteOffs += writeOffsThisPeriod;

                grandTotalMonthlyFeePaymentsAndWriteOffsForBalance += monthlyFeePaymentsThisPeriod;
                grandTotalMonthlyFeePaymentsAndWriteOffsForBalance += writeOffsThisPeriod;

                const periodText = `${formatDate(entry.periodStartDate)} - ${formatDate(entry.periodEndDate)}`;
                const isInactivePeriod = entry.status === 'Inactive';

                let rowClass = '';
                const entryStartDateObj = parseLocalDate(entry.periodStartDate);
                const entryEndDateObj = parseLocalDate(entry.periodEndDate);

                if (isInactivePeriod) {
                    rowClass = 'inactive-period-row'; 
                } else {
                    if (entryEndDateObj < today) {
                        rowClass = 'ledger-row-past';   
                    } else if (entryStartDateObj <= today && entryEndDateObj >= today) {
                        rowClass = 'ledger-row-current'; 
                    }
                }
                
                const periodDisplayHtml = isInactivePeriod ?
                    `<span class="inactive-period-text" onclick="openStatusHistoryModal('${memberId}')" title="View Status History">${periodText} (Inactive)</span>`
                    : periodText;

                const row = `
                    <tr class="${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${isInactivePeriod ? 'text-gray-500' : 'text-gray-900'}">${periodDisplayHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${isInactivePeriod ? 'text-gray-500' : 'text-gray-900'}">${formatCurrency(membershipFeeDueForPeriod)} Rs</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${isInactivePeriod ? 'text-gray-500' : 'text-gray-900'}">${combinedPaidHtml || `${formatCurrency(0)} Rs`}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${balanceForPeriod !== 0 ? 'font-medium' : ''} ${balanceForPeriod < 0 ? 'text-green-600' : (balanceForPeriod > 0 ? 'text-red-600' : (isInactivePeriod ? 'text-gray-500' : 'text-gray-900'))}">${formatCurrency(balanceForPeriod)} Rs</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                            ${!isInactivePeriod ? `
                                <button onclick="openLedgerAddPaymentModal('${memberId}', '${entry.periodStartDate}', '${entry.periodEndDate}')" class="text-gray-700 hover:text-gray-900 mr-2 btn-icon-text" title="Record Payment"><i class="fas fa-credit-card text-green-600"></i> Pay</button>
                                <button onclick="openWriteOffModal('${memberId}', '${entry.periodStartDate}', '${entry.periodEndDate}')" class="text-gray-700 hover:text-gray-900 btn-icon-text" title="Write-Off Dues"><i class="fas fa-eraser text-red-600"></i> Write-Off</button>
                            ` : 'N/A'}
                        </td>
                    </tr>
                `;
                memberLedgerBody.innerHTML += row;
            });

            const grandTotalBalance = grandTotalMembershipFeesDue - grandTotalMonthlyFeePaymentsAndWriteOffsForBalance;

            ledgerTotalPaidEl.textContent = `${formatCurrency(grandTotalAllPaymentsAndWriteOffs)} Rs`;
            ledgerTotalBalanceEl.textContent = `${formatCurrency(grandTotalBalance)} Rs`;
            ledgerTotalBalanceEl.className = `px-6 py-3 text-right text-sm font-semibold ${(grandTotalBalance) < 0 ? 'text-green-700' : (grandTotalBalance) > 0 ? 'text-red-700' : 'text-gray-700'}`;
        };


        
        viewMemberHistoryBtn.addEventListener('click', () => {
            if (selectedLedgerMemberId) {
                openMemberDataHistoryModal(selectedLedgerMemberId);
            }
        });

        ledgerPrevYearBtn.addEventListener('click', () => {
            if (selectedLedgerMemberId) {
                selectedLedgerViewYear--;
                renderMemberLedger(selectedLedgerMemberId, selectedLedgerViewYear);
            }
        });

        ledgerNextYearBtn.addEventListener('click', () => {
            if (selectedLedgerMemberId) {
                selectedLedgerViewYear++;
                renderMemberLedger(selectedLedgerMemberId, selectedLedgerViewYear);
            }
        });


        const calculateTotalOverdueForAllMembers = (genderFilter = 'all') => {
            let totalNetOverdue = 0;

            members.forEach(member => {
                if (genderFilter !== 'all' && member.gender !== genderFilter) {
                    return;
                }
                totalNetOverdue += getMemberOverdueAmount(member.id);
            });
            return totalNetOverdue;
        };

        // --- Payment Edit Modal Logic ---
        window.openPaymentEditModal = (paymentId) => { 
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) { console.error("Payment not found for editing:", paymentId); return; }
            const member = members.find(m => m.id === payment.memberId);
            if (!member) { console.error("Member not found for payment:", payment.memberId); return; }


            paymentEditForm.reset();
            editPaymentIdInput.value = payment.id;
            editPaymentMemberIdInput.value = payment.memberId; 
            
            editPaymentMemberNameDisplay.textContent = member.name;
            editPaymentAppliedPeriodDisplay.textContent = payment.appliedToPeriodStartDate ? formatDate(payment.appliedToPeriodStartDate) : 'N/A';
            editPaymentDateInput.value = payment.date; 
            editPaymentTypeDisplay.textContent = payment.paymentType || 'N/A';
            editPaymentAmountInput.value = payment.amount || 0;
            
            paymentEditModal.classList.remove('hidden');
        };

        const closePaymentEditModal = () => {
            paymentEditModal.classList.add('hidden');
        };

        paymentEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const paymentId = editPaymentIdInput.value;
            const memberId = editPaymentMemberIdInput.value;
            const newDateString = editPaymentDateInput.value;
            const newAmount = parseFloat(editPaymentAmountInput.value);

            if (!parseLocalDate(newDateString)) { alert("Invalid payment date."); return; }
            if (isNaN(newAmount) || newAmount < 0) { alert("Invalid payment amount."); return; }

            const paymentIndex = payments.findIndex(p => p.id === paymentId);
            if (paymentIndex === -1) { console.error("Payment to edit not found locally"); return; }
            
            const originalPayment = payments[paymentIndex];
            const paymentData = { 
                ...originalPayment, 
                date: newDateString, 
                amount: newAmount 
            };

            try {
                const updatedPayment = await apiCall(`/payments/${paymentId}`, 'PUT', paymentData);
                payments[paymentIndex] = updatedPayment;

                if (updatedPayment.paymentType === 'Admission Fee') {
                    const memberToUpdate = members.find(m => m.id === memberId);
                    if (memberToUpdate) {
                        memberToUpdate.admissionFee = newAmount;
                        // If member needs full update on backend due to this, do another call or ensure backend handles this logic.
                        // For now, client-side object is updated, next full member save will persist this.
                        // Or, make an API call to update member as well.
                        await apiCall(`/members/${memberId}`, 'PUT', memberToUpdate); // This will re-save the whole member
                    }
                }

                closePaymentEditModal();
                if(selectedLedgerMemberId === memberId) renderMemberLedger(memberId, selectedLedgerViewYear);
                renderMembersTable();
                renderHomeTabContent();
                renderSalesChart(currentChartYear);
                updateRevenueMetrics();
            } catch (error) {
                console.error("Failed to update payment:", error);
            }
        });

        cancelEditPaymentBtn.addEventListener('click', closePaymentEditModal);
        deletePaymentBtn.addEventListener('click', () => {
            const paymentId = editPaymentIdInput.value;
            if (paymentId) {
                closePaymentEditModal(); 
                confirmDeletePayment(paymentId);
            }
        });


        // --- Ledger Add Payment Modal Logic ---
        window.openLedgerAddPaymentModal = (memberId, periodStart, periodEnd) => {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            ledgerAddPaymentForm.reset();
            ledgerAddPaymentMemberIdInput.value = memberId;
            ledgerAddPaymentPeriodStartInput.value = periodStart; 
            ledgerAddPaymentPeriodEndInput.value = periodEnd; 
            
            ledgerAddPaymentMemberNameDisplay.textContent = member.name;
            ledgerAddPaymentPeriodDisplay.textContent = `${formatDate(periodStart)}`; 
            ledgerNewPaymentDateInput.value = getTodayInputDate(); 

            const ledgerEntriesForPeriod = generateLedgerEntries(memberId, `${selectedLedgerViewYear}-12-31`); 
            const targetEntry = ledgerEntriesForPeriod.find(e => e.periodStartDate === periodStart && e.periodEndDate === periodEnd);
            let dueForPeriod = 0;
            if (targetEntry) {
                const paidForPeriod = targetEntry.payments
                    .filter(p => p.paymentType === 'Monthly Fee')
                    .reduce((sum, p) => sum + p.amount, 0);
                const writtenOffForPeriod = targetEntry.writeOffs.reduce((sum, w) => sum + w.amount, 0);
                dueForPeriod = targetEntry.feesDue - paidForPeriod - writtenOffForPeriod;
            }
            ledgerNewPaymentAmountInput.value = dueForPeriod > 0 ? dueForPeriod.toFixed(0) : '';


            ledgerAddPaymentModal.classList.remove('hidden');
        };
        const closeLedgerAddPaymentModal = () => ledgerAddPaymentModal.classList.add('hidden');

        ledgerAddPaymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberId = ledgerAddPaymentMemberIdInput.value;
            const appliedToPeriodStartDate = ledgerAddPaymentPeriodStartInput.value; 
            const paymentMadeOnDate = ledgerNewPaymentDateInput.value; 
            const paymentType = "Monthly Fee";
            const amount = parseFloat(ledgerNewPaymentAmountInput.value);


            if (!memberId || !parseLocalDate(paymentMadeOnDate) || isNaN(amount) || amount <= 0 || !appliedToPeriodStartDate) {
                alert("Please fill all fields with valid data."); return;
            }
            
            const newPaymentData = {
                id: generateId(),
                memberId,
                date: paymentMadeOnDate,
                appliedToPeriodStartDate: appliedToPeriodStartDate,
                paymentType, 
                amount
            };

            try {
                const savedPayment = await apiCall('/payments', 'POST', newPaymentData);
                payments.push(savedPayment);
                
                closeLedgerAddPaymentModal();
                if(selectedLedgerMemberId === memberId) renderMemberLedger(memberId, selectedLedgerViewYear);
                renderMembersTable();
                renderHomeTabContent();
                renderSalesChart(currentChartYear);
                updateRevenueMetrics();
            } catch (error) {
                 console.error("Failed to add payment:", error);
            }
        });

        cancelLedgerAddPaymentBtn.addEventListener('click', closeLedgerAddPaymentModal);


        // --- Write-Off Modal Logic ---
        window.openWriteOffModal = (memberId, periodStart, periodEnd, writeOffIdToEdit = null) => {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            writeoffForm.reset();
            writeoffIdInput.value = writeOffIdToEdit || '';
            writeoffMemberIdInput.value = memberId;
            writeoffPeriodStartDateInput.value = periodStart;
            writeoffPeriodEndDateInput.value = periodEnd;

            writeoffMemberNameDisplay.textContent = member.name;
            writeoffPeriodDisplay.textContent = `${formatDate(periodStart)} - ${formatDate(periodEnd)}`;
            writeoffDateInput.value = getTodayInputDate();
            saveWriteoffBtn.textContent = "Save Write-Off";

            if (writeOffIdToEdit) {
                const writeOff = writeOffs.find(w => w.id === writeOffIdToEdit);
                if (writeOff) {
                    writeoffModalTitle.textContent = "Edit Write-Off";
                    writeoffAmountInput.value = writeOff.amount;
                    writeoffDateInput.value = writeOff.date;
                    writeoffNotesInput.value = writeOff.notes || '';
                    deleteWriteoffBtn.classList.remove('hidden');
                } else { return; } 
            } else {
                writeoffModalTitle.textContent = "Add Write-Off";
                deleteWriteoffBtn.classList.add('hidden');
            }
            writeoffModal.classList.remove('hidden');
        };
        const closeWriteOffModal = () => writeoffModal.classList.add('hidden');

        writeoffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = writeoffIdInput.value;
            const memberId = writeoffMemberIdInput.value;
            const periodStartDate = writeoffPeriodStartDateInput.value;
            const periodEndDate = writeoffPeriodEndDateInput.value;
            const amount = parseFloat(writeoffAmountInput.value);
            const date = writeoffDateInput.value;
            const notes = writeoffNotesInput.value.trim();

            if (!memberId || !periodStartDate || !periodEndDate || isNaN(amount) || amount <= 0 || !parseLocalDate(date)) {
                alert("Please fill all fields with valid data."); return;
            }
            
            const writeOffData = { id: id || generateId(), memberId, periodStartDate, periodEndDate, amount, date, notes };
            const isNew = !id;

            try {
                const savedWriteOff = await apiCall(isNew ? '/writeoffs' : `/writeoffs/${id}`, isNew ? 'POST' : 'PUT', writeOffData);
                if (isNew) {
                    writeOffs.push(savedWriteOff);
                } else {
                    const index = writeOffs.findIndex(w => w.id === id);
                    if (index > -1) writeOffs[index] = savedWriteOff;
                }
                
                closeWriteOffModal();
                if(selectedLedgerMemberId === memberId) renderMemberLedger(memberId, selectedLedgerViewYear); 
                renderMembersTable();
                updateRevenueMetrics();
            } catch (error) {
                console.error("Failed to save write-off:", error);
            }
        });
        cancelWriteoffBtn.addEventListener('click', closeWriteOffModal);

        deleteWriteoffBtn.addEventListener('click', () => {
            const writeOffId = writeoffIdInput.value;
            if (writeOffId) {
                closeWriteOffModal(); 
                confirmDeleteWriteOff(writeOffId); 
            }
        });

        // --- Status History Modal (View only) ---
        window.openStatusHistoryModal = (memberId) => { 
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            statusHistoryMemberNameEl.textContent = member.name;
            statusHistoryTableBody.innerHTML = '';

            if (!member.statusHistory || member.statusHistory.length === 0) {
                statusHistoryTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-gray-500">No status history found.</td></tr>`;
            } else {
                const sortedHistory = [...member.statusHistory].sort((a,b) => {
                    const dateA = parseLocalDate(a.effectiveDate);
                    const dateB = parseLocalDate(b.effectiveDate);
                    if (!dateA || !dateB) return 0;
                    if (dateA.getTime() === dateB.getTime()) return (a.id && b.id && a.id > b.id) ? 1 : -1; // Consistent sort
                    return dateA - dateB;
                });
                sortedHistory.forEach(entry => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${entry.value}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(entry.effectiveDate)}</td>
                        </tr>
                    `;
                    statusHistoryTableBody.innerHTML += row;
                });
            }
            statusHistoryModal.classList.remove('hidden');
        };
        closeStatusHistoryBtn.addEventListener('click', () => statusHistoryModal.classList.add('hidden'));


        // --- Payment Deletion Logic ---
        window.confirmDeletePayment = (paymentId) => {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;

            const member = members.find(m => m.id === payment.memberId);
            confirmationTitle.textContent = 'Delete Payment';
            confirmationMessage.textContent = `Delete payment of ${formatCurrency(payment.amount)} Rs for ${member ? member.name : 'N/A'} (Made on: ${formatDate(payment.date)}, Applied to: ${formatDate(payment.appliedToPeriodStartDate)})? This cannot be undone.`;
            confirmActionBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md';
            currentActionCallback = () => deletePayment(paymentId);
            confirmationModal.classList.remove('hidden');
        };

        const deletePayment = async (paymentId) => {
            const paymentToDelete = payments.find(p => p.id === paymentId);
            if (!paymentToDelete) {
                 console.error("Payment to delete not found locally:", paymentId);
                 closeConfirmationModal();
                 return;
            }
            const memberIdOfDeletedPayment = paymentToDelete.memberId;

            try {
                await apiCall(`/payments/${paymentId}`, 'DELETE');
                payments = payments.filter(p => p.id !== paymentId); // Remove from local array

                 if (paymentToDelete.paymentType === 'Admission Fee') {
                    const memberIndex = members.findIndex(m => m.id === memberIdOfDeletedPayment);
                    if (memberIndex !== -1) {
                        const memberToUpdate = { ...members[memberIndex], admissionFee: 0 };
                        // Also update the member on the backend
                        const updatedMember = await apiCall(`/members/${memberIdOfDeletedPayment}`, 'PUT', memberToUpdate);
                        members[memberIndex] = updatedMember; // Update local member
                    }
                 }
                
                closeConfirmationModal();
                if(selectedLedgerMemberId === memberIdOfDeletedPayment) {
                    renderMemberLedger(memberIdOfDeletedPayment, selectedLedgerViewYear);
                }
                renderMembersTable();
                renderHomeTabContent();
                renderSalesChart(currentChartYear);
                updateRevenueMetrics();
            } catch (error) {
                console.error("Failed to delete payment:", error);
            }
        };
        
        // --- WriteOff Deletion ---
        window.confirmDeleteWriteOff = (writeOffId) => { 
            const writeOff = writeOffs.find(w => w.id === writeOffId);
            if (!writeOff) return;
            const member = members.find(m => m.id === writeOff.memberId);
            confirmationTitle.textContent = 'Delete Write-Off';
            confirmationMessage.textContent = `Delete write-off of ${formatCurrency(writeOff.amount)} Rs for ${member ? member.name : 'N/A'} (Period: ${formatDate(writeOff.periodStartDate)} - ${formatDate(writeOff.periodEndDate)})? This cannot be undone.`;
            confirmActionBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md';
            currentActionCallback = () => deleteWriteOff(writeOffId);
            confirmationModal.classList.remove('hidden');
        };

        const deleteWriteOff = async (writeOffId) => {
            const woToDelete = writeOffs.find(w => w.id === writeOffId);
            if (!woToDelete) return;
            const memberIdOfDeletedWo = woToDelete.memberId;

            try {
                await apiCall(`/writeoffs/${writeOffId}`, 'DELETE');
                writeOffs = writeOffs.filter(w => w.id !== writeOffId);
                
                closeConfirmationModal();
                if(selectedLedgerMemberId === memberIdOfDeletedWo) renderMemberLedger(memberIdOfDeletedWo, selectedLedgerViewYear);
                renderMembersTable();
                updateRevenueMetrics();
            } catch (error) {
                console.error("Failed to delete write-off:", error);
            }
        };


        // --- Member Data History Modal & Editing Logic ---
        const historyTypeLabels = {
            statusHistory: 'Status',
            monthlyFeeHistory: 'Monthly Fee',
            paymentCycleDayHistory: 'Monthly Payment Date'
        };

                const openMemberDataHistoryModal = (memberId) => {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            const todayStr = getTodayInputDate(); 
            const todayDateObj = parseLocalDate(todayStr); 

            selectedLedgerMemberId = memberId; // Potentially redundant if always called from ledger
            historyModalMemberNameEl.textContent = member.name;
            historyModalJoinDateEl.textContent = formatDate(member.joinDate);

            historyModalCurrentStatusEl.textContent = getEffectiveValue(member.statusHistory, todayStr, 'N/A');
            historyModalCurrentFeeEl.textContent = `${formatCurrency(getEffectiveValue(member.monthlyFeeHistory, todayStr, 0))} Rs`;
            const currentPaymentDay = getEffectiveValue(member.paymentCycleDayHistory, todayStr, 'N/A');
            historyModalCurrentPaymentDayEl.textContent = currentPaymentDay !== 'N/A' ? `Day ${currentPaymentDay}` : 'N/A';


            memberDataHistoryItemsContainerEl.innerHTML = '';
            const allHistoryEntries = [];

            Object.keys(historyTypeLabels).forEach(key => {
                if (member[key] && member[key].length > 0) {
                    member[key].forEach(entry => {
                        allHistoryEntries.push({ ...entry, historyType: key });
                    });
                }
            });

            allHistoryEntries.sort((a, b) => {
                const dateA = parseLocalDate(a.effectiveDate);
                const dateB = parseLocalDate(b.effectiveDate);
                if (!dateA || !dateB) return 0;
                if (dateA.getTime() === dateB.getTime()) return (a.id && b.id && a.id > b.id) ? 1 : -1;
                return dateA - dateB;
            });

            if (allHistoryEntries.length === 0) {
                 memberDataHistoryItemsContainerEl.innerHTML = `<p class="text-gray-500 text-center py-4">No historical changes found.</p>`;
            }

            let hasInsertedTodayDivider = false; 
            let hasInsertedJoinDateDivider = false;

            allHistoryEntries.forEach(entry => {
                const entryEffectiveDateObj = parseLocalDate(entry.effectiveDate);

                if (!hasInsertedTodayDivider && entryEffectiveDateObj && entryEffectiveDateObj >= todayDateObj) {
                    const dividerDiv = document.createElement('div');
                    dividerDiv.className = 'relative flex py-3 items-center'; 
                    dividerDiv.innerHTML = `
                        <div class="flex-grow border-t border-green-400"></div>
                        <span class="flex-shrink mx-4 text-green-600 text-sm font-semibold">TODAY (${formatDate(todayDateObj)})</span>
                        <div class="flex-grow border-t border-green-400"></div>
                    `;
                    memberDataHistoryItemsContainerEl.appendChild(dividerDiv);
                    hasInsertedTodayDivider = true;
                }

                // Insert Join Date Divider
                if (!hasInsertedJoinDateDivider && entryEffectiveDateObj && member.joinDate === entry.effectiveDate) {
                    const joinDateDividerDiv = document.createElement('div');
                    joinDateDividerDiv.className = 'relative flex py-3 items-center';
                    joinDateDividerDiv.innerHTML = `
                        <div class="flex-grow border-t border-blue-400"></div>
                        <span class="flex-shrink mx-4 text-blue-600 text-sm font-semibold">JOINED (${formatDate(member.joinDate)})</span>
                        <div class="flex-grow border-t border-blue-400"></div>
                    `;
                    // Insert before the current entry if it's the first one matching join date or if no entries yet
                    memberDataHistoryItemsContainerEl.appendChild(joinDateDividerDiv);
                    hasInsertedJoinDateDivider = true;
                }


                const specificHistoryArray = member[entry.historyType];
                const sortedSpecificHistory = [...specificHistoryArray].sort((x,y) => {
                    const dx = parseLocalDate(x.effectiveDate); const dy = parseLocalDate(y.effectiveDate);
                    if (!dx || !dy) return 0;
                    if (dx.getTime() === dy.getTime()) return (x.id && y.id && x.id > y.id ? 1 : -1);
                    return dx - dy;
                });
                const isThisTheInitialEntryForType = sortedSpecificHistory.length > 0 && sortedSpecificHistory[0].id === entry.id;

                let valueDisplay = entry.value;
                if (entry.historyType === 'monthlyFeeHistory') valueDisplay = `${formatCurrency(entry.value)} Rs`;
                else if (entry.historyType === 'statusHistory') valueDisplay = entry.value;
                else if (entry.historyType === 'paymentCycleDayHistory') valueDisplay = `Day ${entry.value} of each month`;


                let actionButtonsHtml = '';

                actionButtonsHtml += `
                    <button onclick="openEditHistoryEntryDateModal('${member.id}', '${entry.id}', '${entry.historyType}')"
                            class="text-indigo-500 hover:text-indigo-700 text-sm p-1" title="Edit Effective Date">
                            <i class="fas fa-calendar-alt"></i>
                    </button>`;

                if (!isThisTheInitialEntryForType && specificHistoryArray.length > 1) { 
                     actionButtonsHtml += `
                        <button onclick="confirmDeleteHistoryEntry('${member.id}', '${entry.id}', '${entry.historyType}')"
                                class="text-red-500 hover:text-red-700 text-sm p-1" title="Delete Entry">
                                <i class="fas fa-trash-alt"></i>
                        </button>`;
                } else { 
                     actionButtonsHtml += `<span class="p-1 text-transparent" aria-hidden="true"><i class="fas fa-trash-alt"></i></span>`;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-2 border border-gray-200 rounded-md shadow-sm bg-white flex justify-between items-center';
                itemDiv.innerHTML = `
                    <div class="flex-1">
                        <p class="text-sm text-gray-800"><strong class="text-indigo-700">${historyTypeLabels[entry.historyType]}:</strong> ${valueDisplay} <span class="text-xs text-gray-500 ml-2">Effective: ${formatDate(entry.effectiveDate)}</span></p>
                    </div>
                    <div class="space-x-2 flex items-center">
                        ${actionButtonsHtml}
                    </div>
                `;
                memberDataHistoryItemsContainerEl.appendChild(itemDiv);
            });

            if (!hasInsertedTodayDivider && allHistoryEntries.length > 0 && parseLocalDate(allHistoryEntries[allHistoryEntries.length - 1].effectiveDate) < todayDateObj) {
                 const dividerDiv = document.createElement('div');
                 dividerDiv.className = 'relative flex py-3 items-center';
                 dividerDiv.innerHTML = `
                     <div class="flex-grow border-t border-green-400"></div>
                     <span class="flex-shrink mx-4 text-green-600 text-sm font-semibold">TODAY (${formatDate(todayDateObj)})</span>
                     <div class="flex-grow border-t border-green-400"></div>
                 `;
                 memberDataHistoryItemsContainerEl.appendChild(dividerDiv);
                 hasInsertedTodayDivider = true;
            }
            memberDataHistoryModal.classList.remove('hidden');
        };


        const closeMemberDataHistoryModal = () => memberDataHistoryModal.classList.add('hidden');
        closeMemberDataHistoryModalBtn.addEventListener('click', closeMemberDataHistoryModal);
 

        window.confirmDeleteHistoryEntry = (memberId, entryId, historyType) => {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            const historyArray = member[historyType];
            if (!historyArray) return;
            const entry = historyArray.find(e => e.id === entryId);
            if(!entry) return;
            
            const sortedHistoryForType = [...historyArray].sort((x,y) => {
                const dx=parseLocalDate(x.effectiveDate); const dy=parseLocalDate(y.effectiveDate);
                if(!dx || !dy) return 0;
                return dx - dy || (x.id && y.id && x.id > y.id ? 1 : -1);
            });
            // Check if it's the first entry chronologically *and* its date is the member's join date
            const isInitialJoinDateEntry = sortedHistoryForType.length > 0 && 
                                         sortedHistoryForType[0].id === entry.id && 
                                         entry.effectiveDate === member.joinDate;

            if (isInitialJoinDateEntry || historyArray.length <= 1) {
                 alert("Initial entry linked to join date, or the only entry for this type, cannot be deleted this way. Adjust member details or add a new overriding entry.");
                 return;
            }

            confirmationTitle.textContent = 'Delete History Entry';
            confirmationMessage.textContent = `Delete this '${historyTypeLabels[historyType]}' entry (Effective: ${formatDate(entry.effectiveDate)}, Value: ${entry.value})? This may affect ledger calculations.`;
            confirmActionBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md';
            currentActionCallback = () => deleteHistoryEntry(memberId, entryId, historyType);
            confirmationModal.classList.remove('hidden');
        };

        const deleteHistoryEntry = async (memberId, entryId, historyType) => {
            try {
                const updatedMember = await apiCall(`/members/${memberId}/history/${historyType}/${entryId}`, 'DELETE');
                // Update local member data
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    members[memberIndex] = updatedMember;
                }
                
                closeConfirmationModal();
                openMemberDataHistoryModal(memberId); // Refresh history modal
                if (selectedLedgerMemberId === memberId) renderMemberLedger(memberId, selectedLedgerViewYear);
                updateRevenueMetrics();
                renderMembersTable();
            } catch (error) {
                console.error("Failed to delete history entry:", error);
                // Error already alerted by apiCall
                closeConfirmationModal();
            }
        };


        window.openEditHistoryEntryDateModal = (memberId, entryId, historyType) => {
            const member = members.find(m => m.id === memberId);
            if (!member) { console.error("Member not found:", memberId); return; }
            const historyArray = member[historyType];
            if (!historyArray) { console.error("History type not found on member:", historyType); return; }
            const entry = historyArray.find(e => e.id === entryId);
            if (!entry) { console.error("History entry not found:", entryId); return; }

            editHistoryEffectiveDateForm.reset();
            editHistoryDateError.classList.add('hidden');
            editHistoryDateError.textContent = '';

            editHistoryMemberIdInput.value = memberId;
            editHistoryEntryIdInput.value = entryId;
            editHistoryTypeInput.value = historyType;            
            editHistoryNewEffectiveDateInput.value = entry.effectiveDate; 
            editHistoryNewEffectiveDateInput.min = member.joinDate; 

            editHistoryEffectiveDateModal.classList.remove('hidden');
        };

        const closeEditHistoryEntryDateModal = () => {
            editHistoryEffectiveDateModal.classList.add('hidden');
        };
        cancelEditHistoryDateBtn.addEventListener('click', closeEditHistoryEntryDateModal);
        editHistoryEffectiveDateModal.addEventListener('click', (e) => { 
            if (e.target === editHistoryEffectiveDateModal) closeEditHistoryEntryDateModal(); 
        });


        editHistoryEffectiveDateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editHistoryDateError.classList.add('hidden');
            editHistoryDateError.textContent = '';

            const memberId = editHistoryMemberIdInput.value;
            const entryId = editHistoryEntryIdInput.value;
            const historyType = editHistoryTypeInput.value;
            const newEffectiveDateStr = editHistoryNewEffectiveDateInput.value;

            const member = members.find(m => m.id === memberId);
            if (!member) {
                editHistoryDateError.textContent = "Error: Member not found.";
                editHistoryDateError.classList.remove('hidden');
                return;
            }
            const newEffectiveDateObj = parseLocalDate(newEffectiveDateStr);
            const memberJoinDateObj = parseLocalDate(member.joinDate);

            if (!newEffectiveDateObj) {
                editHistoryDateError.textContent = "Invalid date format selected.";
                editHistoryDateError.classList.remove('hidden');
                return;
            }
            if (memberJoinDateObj && newEffectiveDateObj < memberJoinDateObj) {
                editHistoryDateError.textContent = `Effective date cannot be before member's join date (${formatDate(member.joinDate)}).`;
                editHistoryDateError.classList.remove('hidden');
                return;
            }
            
            try {
                // The API will return the full updated member object
                const updatedMember = await apiCall(`/members/${memberId}/history/${historyType}/${entryId}`, 'PUT', { newEffectiveDate: newEffectiveDateStr });
                
                // Update local member data
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    members[memberIndex] = updatedMember;
                } else { // Should not happen if member was found above
                    members.push(updatedMember); // Or handle error
                }
                
                closeEditHistoryEntryDateModal();
                openMemberDataHistoryModal(memberId); 
                
                if (selectedLedgerMemberId === memberId) {
                    renderMemberLedger(memberId, selectedLedgerViewYear);
                }
                updateRevenueMetrics();
                renderMembersTable();
            } catch (error) {
                 console.error("Failed to update history entry date:", error);
                 editHistoryDateError.textContent = error.message || "Failed to save changes.";
                 editHistoryDateError.classList.remove('hidden');
            }
        });

        // --- Confirmation Modal Logic ---
        const closeConfirmationModal = () => { confirmationModal.classList.add('hidden'); currentActionCallback = null; };
        confirmCancelBtn.addEventListener('click', closeConfirmationModal);
        confirmActionBtn.addEventListener('click', () => { if (typeof currentActionCallback === 'function') currentActionCallback(); });
        confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) closeConfirmationModal(); });

        // --- Backup Tab Logic ---

const renderBackupTab = async () => {
    backupStatusContainer.innerHTML = `<p class="text-gray-500">Loading backup status...</p>`;
    try {
        const statusRes = await fetch('/api/backup/status');
        const statusData = await statusRes.json();
        
        if (statusData.isAuthorized) {
            const scheduleRes = await fetch('/api/backup/schedule/get');
            const scheduleData = await scheduleRes.json();
            renderAuthorizedBackupView(scheduleData);
        } else {
            renderUnauthorizedBackupView();
        }
    } catch (error) {
        console.error('Error fetching backup status:', error);
        backupStatusContainer.innerHTML = `<p class="text-red-600">Could not fetch backup status. Is the server running?</p>`;
    }
};

const renderUnauthorizedBackupView = () => {
    backupStatusContainer.innerHTML = `
        <div class="p-4 border border-blue-200 bg-blue-50 rounded-lg">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fab fa-google-drive text-blue-500 text-2xl"></i>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium text-blue-800">
                        Connect to Google Drive
                    </p>
                    <p class="text-sm text-blue-700 mt-1">
                        To enable manual and scheduled cloud backups, please authorize the application to access your Google Drive.
                    </p>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button id="authorize-gdrive-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">
                    Authorize
                </button>
            </div>
        </div>
    `;
    document.getElementById('authorize-gdrive-btn').addEventListener('click', () => {
        // Redirect to the backend authorization route
        window.location.href = '/api/backup/authorize';
    });
};

const renderAuthorizedBackupView = (scheduleData) => {
            const scheduleTime = scheduleData.isScheduled ? scheduleData.time : '22:00';
            const displayTime = formatTime12Hour(scheduleData.time);
            // nextRunDisplay variable and its calculation logic removed as it's no longer used.
            
            const scheduleInfo = scheduleData.isScheduled 
                ? `<p class="text-sm text-green-700">Daily backup is currently scheduled for <strong>${displayTime}</strong> everyday.</p>`
                : `<p class="text-sm text-yellow-700">Automatic daily backup is not scheduled.</p>`;

    backupStatusContainer.innerHTML = `
                <!-- Manual Backup -->
                <div class="space-y-2">
                     <h3 class="text-lg font-medium text-gray-700">Manual Backup</h3>
                     <p class="text-sm text-gray-600">Click below button to back up the current database now.</p>
                     <!-- This new div will align the button and feedback message -->
                     <div id="manual-backup-action-container" class="flex items-center">
                         <button id="backup-now-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-2"></i> Backup Now
                         </button>
                         <!-- The feedback span will be added here by the JS -->
                     </div>
                </div>
        <div class="border-t my-6"></div>
        <!-- Scheduled Backup -->
        <div class="space-y-3">
            <h3 class="text-lg font-medium text-gray-700">Scheduled Backup</h3>
            <div class="p-3 border bg-gray-50 rounded-md">${scheduleInfo}</div>
            <div class="flex items-center space-x-4">
                <label for="backup-time" class="text-sm font-medium text-gray-700">Set daily backup time:</label>
                <input type="time" id="backup-time" value="${scheduleTime}" class="px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <button id="set-schedule-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Set Schedule</button>
                <button id="cancel-schedule-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md ${!scheduleData.isScheduled ? 'hidden' : ''}">Cancel Schedule</button>
            </div>
        </div>
    `;

    document.getElementById('backup-now-btn').addEventListener('click', handleBackupNow);
    document.getElementById('set-schedule-btn').addEventListener('click', handleSetSchedule);
    document.getElementById('cancel-schedule-btn').addEventListener('click', handleCancelSchedule);
};

const handleBackupNow = async (event) => {
            const btn = event.currentTarget;
            const container = document.getElementById('manual-backup-action-container');
            
            // Create a feedback element if it doesn't exist
            let feedbackEl = document.getElementById('manual-backup-feedback');
            if (!feedbackEl) {
                feedbackEl = document.createElement('span');
                feedbackEl.id = 'manual-backup-feedback';
                // Add left margin to space it from the button
                feedbackEl.className = 'ml-4 text-sm'; 
                // Append it to the new flex container
                if (container) {
                    container.appendChild(feedbackEl);
                }
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Backing up...`;
            if (feedbackEl) feedbackEl.textContent = ''; // Clear previous feedback

            try {
                const response = await apiCall('/backup/now', 'POST', {});
                if (feedbackEl) {
                    feedbackEl.textContent = 'Backup successful!';
                    feedbackEl.className = 'ml-4 text-sm font-medium text-green-600';
                }
            } catch (error) {
                if (feedbackEl) {
                    feedbackEl.textContent = `Error: ${error.message}`;
                    feedbackEl.className = 'ml-4 text-sm font-medium text-red-600';
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-cloud-upload-alt mr-2"></i> Backup Now`;
                // Optionally clear the message after a few seconds
                setTimeout(() => {
                    if (feedbackEl) feedbackEl.textContent = '';
                }, 6000);
            }
        };

const handleSetSchedule = async () => {
            const backupTime = document.getElementById('backup-time').value; // This is still "HH:mm"
            const formattedTime = formatTime12Hour(backupTime); // Convert for display
            try {
                // We still send the 24-hour time to the backend
                await apiCall('/backup/schedule/set', 'POST', { time: backupTime });
                renderBackupTab(); // Re-render to show updated status
                // But we show the user the friendly 12-hour format in the notification
                showBackupNotification(`Schedule successfully set for ${formattedTime} daily.`, true);
            } catch (error) {
                 showBackupNotification(error.message, false);
            }
        };

const handleCancelSchedule = async () => {
    try {
        await apiCall('/backup/schedule/cancel', 'POST', {});
        renderBackupTab(); // Re-render
        showBackupNotification('Schedule successfully cancelled.', true);
    } catch (error) {
        showBackupNotification(error.message, false);
    }
};


        // --- Initialization ---
        const initializeApp = async () => {
            console.log(`Initializing Gym App with SQLite backend...`);
            try {
                const data = await apiCall('/all-data');
                members = data.members || [];
                payments = data.payments || [];
                writeOffs = data.writeoffs || [];

                console.log("Data loaded from server:", {
                    membersCount: members.length,
                    paymentsCount: payments.length,
                    writeOffsCount: writeOffs.length
                });


            } catch (error) {
                console.error("Failed to load initial data:", error);
                membersTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading data from server. Please ensure the backend server is running and accessible.</td></tr>`;
            }
            
            // Proceed with UI setup even if data load failed, to make UI responsive.
            updateRevenueMetrics();
            renderMembersTable();
            renderSalesChart(currentChartYear);
            renderHomeTabContent();

            if (salesChartCanvasContainer && isSalesChartBlurred) {
                salesChartCanvasContainer.classList.add('blurred');
            }

            addMemberBtn.addEventListener('click', () => openMemberModal());
            cancelMemberBtn.addEventListener('click', closeMemberModal);
            memberModal.addEventListener('click', (e) => { if (e.target === memberModal) closeMemberModal(); });

            if (clearLedgerSelectionBtn) {
                clearLedgerSelectionBtn.addEventListener('click', resetLedgerSelectionAndDisplay);
            }
            // Event listener for the new Edit Member button in Ledger tab
            if (editLedgerMemberBtn) {
                editLedgerMemberBtn.addEventListener('click', () => {
                    if (selectedLedgerMemberId) {
                        editMember(selectedLedgerMemberId);
                    }
                });
            }

            tabLinks.forEach(link => link.classList.remove('tab-active', 'bg-indigo-100'));
            document.querySelector('.tab-link[data-tab="home"]').classList.add('tab-active', 'bg-indigo-100');
            tabContents.forEach(content => content.id === 'home-content' ? content.classList.remove('hidden') : content.classList.add('hidden'));

            // After authorization, the URL will be #backup. This handles rendering the tab.
            if(window.location.hash === '#backup') {
            const backupLink = document.querySelector('.tab-link[data-tab="backup"]');
            if(backupLink) backupLink.click();
            }
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>